<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tecno-Checklist Dinâmico</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Tecno-Checklist">
    <meta name="msapplication-TileColor" content="#1e40af">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --primary-light: #3b82f6;
            --secondary: #f59e0b;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --light: #f8fafc;
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--gray-900);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        /* ANIMATED BACKGROUND */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .animated-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            animation: float 20s ease-in-out infinite;
        }

        .floating-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .shape {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        .shape:nth-child(1) {
            width: 80px;
            height: 80px;
            top: 20%;
            left: 10%;
            animation-delay: 0s;
        }

        .shape:nth-child(2) {
            width: 120px;
            height: 120px;
            top: 60%;
            right: 10%;
            animation-delay: 2s;
        }

        .shape:nth-child(3) {
            width: 60px;
            height: 60px;
            top: 80%;
            left: 20%;
            animation-delay: 4s;
        }

        .shape:nth-child(4) {
            width: 100px;
            height: 100px;
            top: 30%;
            right: 30%;
            animation-delay: 1s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(30, 64, 175, 0.5); }
            50% { box-shadow: 0 0 20px rgba(30, 64, 175, 0.8), 0 0 30px rgba(30, 64, 175, 0.6); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            animation: slideInUp 1s ease-out;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
            animation: float 15s ease-in-out infinite;
        }

        .header-content {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .header h1 {
            font-size: 4rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            animation: pulse 2s ease-in-out infinite;
        }

        .header p {
            font-size: 1.5rem;
            font-weight: 400;
            opacity: 0.9;
            animation: slideInUp 1.2s ease-out 0.3s both;
        }

        /* LOGIN */
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 2rem;
            padding: 3rem;
            max-width: 500px;
            margin: 4rem auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            animation: slideInUp 1s ease-out 0.5s both;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 50%, var(--secondary) 100%);
            border-radius: 2rem 2rem 0 0;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
            animation: slideInLeft 1s ease-out 0.7s both;
        }

        .login-header h2 {
            color: var(--primary);
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-header p {
            color: var(--gray-600);
            font-size: 1.1rem;
        }

        /* FORMS */
        .form-group {
            margin-bottom: 1.5rem;
            animation: slideInRight 1s ease-out 0.9s both;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 1.2rem;
            border: 2px solid var(--gray-200);
            border-radius: 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            color: var(--gray-900);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.1);
            transform: translateY(-2px);
            animation: glow 2s ease-in-out infinite;
        }

        /* BUTTONS */
        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 1.2rem 2.5rem;
            border-radius: 1rem;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            position: relative;
            overflow: hidden;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            animation: slideInUp 1s ease-out 1.1s both;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 35px rgba(30, 64, 175, 0.4);
            animation: bounce 0.6s ease-in-out;
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--gray-600) 0%, var(--gray-700) 100%);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, var(--gray-700) 0%, var(--gray-800) 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info) 0%, #2563eb 100%);
        }

        .btn-accent {
            background: linear-gradient(135deg, var(--accent) 0%, #0891b2 100%);
        }

        /* MAIN APP */
        .main-app {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 2rem;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 2rem;
            animation: slideInUp 1s ease-out;
        }

        /* NAVIGATION */
        .nav {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.9);
            color: var(--gray-700);
            border: 2px solid transparent;
            padding: 1.5rem 2rem;
            border-radius: 1rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .nav-btn:hover::before {
            opacity: 1;
        }

        .nav-btn:hover {
            color: white;
            border-color: var(--primary);
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 25px rgba(30, 64, 175, 0.3);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(30, 64, 175, 0.4);
        }

        .nav-btn i {
            position: relative;
            z-index: 1;
            font-size: 1.2rem;
        }

        .nav-btn span {
            position: relative;
            z-index: 1;
        }

        /* SECTIONS */
        .section {
            display: none;
            animation: slideInUp 0.6s ease-out;
        }

        .section.active {
            display: block;
        }

        .hidden {
            display: none !important;
        }

        /* STATS */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 2.5rem;
            border-radius: 1.5rem;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: slideInUp 0.8s ease-out;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-card h3 {
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: pulse 2s ease-in-out infinite;
        }

        .stat-card p {
            font-size: 1.1rem;
            color: var(--gray-600);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-card i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 1rem;
            animation: bounce 2s ease-in-out infinite;
        }

        /* FEATURE CARDS */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: slideInUp 0.8s ease-out;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .feature-card h3 {
            color: var(--primary);
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feature-card ul {
            list-style: none;
            padding: 0;
        }

        .feature-card li {
            padding: 0.5rem 0;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .feature-card li:hover {
            color: var(--primary);
            transform: translateX(5px);
        }

        .feature-card li i {
            color: var(--success);
            animation: pulse 2s ease-in-out infinite;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                padding: 0 0.5rem;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .header p {
                font-size: 1.2rem;
            }
            
            .nav {
                grid-template-columns: 1fr;
                gap: 0.5rem;
                padding: 1rem;
            }
            
            .nav-btn {
                padding: 1rem;
                font-size: 0.9rem;
            }
            
            .stats {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1.5rem;
            }
            
            .stat-card h3 {
                font-size: 2.5rem;
            }
            
            .login-container {
                margin: 2rem auto;
                padding: 1.5rem;
            }
            
            .feature-card {
                padding: 1.5rem;
            }
            
            .feature-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            /* FORMULÁRIOS RESPONSIVOS */
            #cliente-form,
            #tecnico-form,
            #tarefa-form,
            #usuario-form {
                grid-template-columns: 1fr !important;
                gap: 1rem;
            }
            
            .form-group[style*="grid-column: 1 / -1"] {
                grid-column: 1 !important;
            }
            
            /* TABELAS RESPONSIVAS */
            .table {
                font-size: 0.8rem;
            }
            
            .table th,
            .table td {
                padding: 0.5rem;
            }
            
            .btn-sm {
                padding: 0.3rem 0.6rem;
                font-size: 0.75rem;
            }
            
            /* TASK CARDS RESPONSIVAS */
            .task-card {
                padding: 1rem;
            }
            
            .task-details {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .task-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .task-actions .btn {
                width: 100%;
                justify-content: center;
            }
            
            /* FILTROS RESPONSIVOS */
            .filtros-container {
                grid-template-columns: 1fr !important;
            }
            
            .filtros-container .form-group {
                margin-bottom: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .login-container {
                margin: 1rem auto;
                padding: 1rem;
            }
            
            .stat-card h3 {
                font-size: 2rem;
            }
            
            .feature-card {
                padding: 1rem;
            }
            
            .table {
                font-size: 0.7rem;
            }
            
            .table th,
            .table td {
                padding: 0.3rem;
            }
            
            .btn {
                padding: 0.8rem 1.5rem;
                font-size: 0.9rem;
            }
            
            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.7rem;
            }
            
            .task-card {
                padding: 0.8rem;
            }
            
            .task-title {
                font-size: 1.1rem;
            }
            
            .checklist-item {
                font-size: 0.9rem;
            }
            
            .checklist-toggle {
                width: 25px;
                height: 25px;
                font-size: 1rem;
            }
            
            .checklist-title {
                font-size: 0.9rem;
            }
        }

        /* LOADING ANIMATION */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* NOTIFICATION */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-left: 4px solid var(--success);
            z-index: 1000;
            animation: slideInRight 0.5s ease-out;
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        .notification.info {
            border-left-color: var(--info);
        }

        /* TABLES */
        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: slideInUp 0.6s ease-out;
        }

        .table thead {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.875rem;
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            color: var(--gray-700);
        }

        .table tbody tr {
            /* transition: all 0.3s ease; */
        }

        .table tbody tr:hover {
            background: var(--gray-50);
            transform: scale(1.01);
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        /* TASK CARDS */
        .task-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .task-card.prioridade-baixa {
            border-left-color: var(--success);
        }

        .task-card.prioridade-media {
            border-left-color: var(--warning);
        }

        .task-card.prioridade-alta {
            border-left-color: var(--danger);
        }

        .task-card.prioridade-urgente {
            border-left-color: var(--danger);
            animation: pulse 2s ease-in-out infinite;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .task-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }

        .task-status {
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-pendente {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .status-em-andamento {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
        }

        .status-concluida {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .task-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .task-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-600);
        }

        .task-detail i {
            color: var(--primary);
            width: 16px;
        }

        .task-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border-radius: 0.5rem;
        }

        /* CHECKLIST */
        .checklist-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            cursor: pointer;
            user-select: none;
        }

        .checklist-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
            margin: 0;
        }

        .checklist-toggle {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .checklist-toggle:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .checklist-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .checklist-content.expanded {
            max-height: 500px;
        }

        .checklist {
            margin-top: 0.5rem;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            transition: all 0.3s ease;
        }

        .checklist-item:hover {
            background: var(--gray-50);
            padding-left: 0.5rem;
            border-radius: 0.5rem;
        }

        .checklist-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .checklist-item.completed {
            text-decoration: line-through;
            color: var(--gray-500);
        }

        /* Dashboard Avançado */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .dashboard-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
        }

        .metric-card {
            text-align: center;
            padding: 2rem 1rem;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .metric-label {
            color: var(--gray-600);
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        .chart-container canvas {
            max-height: 300px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-item {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            pointer-events: none;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .stat-icon {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 2rem;
            opacity: 0.3;
        }

        .recent-activities {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            transition: background-color 0.2s ease;
        }

        .activity-item:hover {
            background-color: var(--gray-50);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1.2rem;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .activity-time {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Sistema de Notificações */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
        }

        .notification {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            margin-bottom: 10px;
            padding: 16px;
            border-left: 4px solid var(--primary);
            transform: translateX(100%);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        .notification-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: 600;
            color: var(--gray-900);
            font-size: 14px;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-message {
            color: var(--gray-600);
            font-size: 13px;
            line-height: 1.4;
        }

        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: var(--primary);
            border-radius: 0 0 12px 12px;
            animation: notificationProgress 5s linear forwards;
        }

        @keyframes notificationProgress {
            from { width: 100%; }
            to { width: 0%; }
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .notification-bell:hover {
            background: var(--gray-100);
        }

        .notification-bell.has-notifications {
            color: var(--danger);
        }

        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .notification-dropdown.show {
            display: block;
        }

        .notification-dropdown-header {
            padding: 16px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .notification-dropdown-title {
            font-weight: 600;
            color: var(--gray-900);
        }

        .notification-dropdown-clear {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 12px;
            text-decoration: underline;
        }

        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--gray-100);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .notification-item:hover {
            background: var(--gray-50);
        }

        .notification-item.unread {
            background: rgba(59, 130, 246, 0.1);
        }

        .notification-item-title {
            font-weight: 500;
            color: var(--gray-900);
            font-size: 13px;
            margin-bottom: 4px;
        }

        .notification-item-message {
            color: var(--gray-600);
            font-size: 12px;
            line-height: 1.3;
        }

        .notification-item-time {
            color: var(--gray-400);
            font-size: 11px;
            margin-top: 4px;
        }

        /* Sistema de Comentários e Anexos */
        .comments-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--gray-200);
        }

        .comments-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .comments-title {
            font-weight: 600;
            color: var(--gray-900);
            font-size: 1.1rem;
        }

        .comment-form {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }

        .comment-input {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            resize: vertical;
            font-family: inherit;
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .comment-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .file-upload {
            position: relative;
            display: inline-block;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--gray-700);
            transition: all 0.2s ease;
        }

        .file-upload-label:hover {
            background: var(--gray-200);
        }

        .comments-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .comment-item {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            position: relative;
        }

        .comment-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .comment-author {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.875rem;
        }

        .comment-time {
            color: var(--gray-500);
            font-size: 0.75rem;
        }

        .comment-content {
            color: var(--gray-700);
            font-size: 0.875rem;
            line-height: 1.5;
            margin-bottom: 0.75rem;
        }

        .comment-attachments {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .attachment-item {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--gray-100);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            color: var(--gray-700);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .attachment-item:hover {
            background: var(--gray-200);
            color: var(--primary);
        }

        .attachment-icon {
            font-size: 0.875rem;
        }

        .comment-actions-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .comment-action-btn {
            background: none;
            border: none;
            color: var(--gray-500);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            transition: all 0.2s ease;
        }

        .comment-action-btn:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .image-preview:hover {
            transform: scale(1.05);
        }

        .modal-image {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 0.5rem;
        }

        .empty-comments {
            text-align: center;
            color: var(--gray-500);
            font-style: italic;
            padding: 2rem;
        }

        /* Sistema de Backup e Sincronização */
        .backup-section {
            background: var(--gray-50);
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .backup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .backup-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .backup-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .backup-stat {
            background: white;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            text-align: center;
        }

        .backup-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .backup-stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .backup-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .backup-history {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid var(--gray-200);
        }

        .backup-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid var(--gray-100);
            transition: background-color 0.2s ease;
        }

        .backup-item:hover {
            background: var(--gray-50);
        }

        .backup-item:last-child {
            border-bottom: none;
        }

        .backup-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .backup-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .backup-details {
            flex: 1;
        }

        .backup-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .backup-meta {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .backup-actions-item {
            display: flex;
            gap: 0.5rem;
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 250px;
        }

        .sync-status-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .sync-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .sync-indicator.syncing {
            background: var(--warning);
        }

        .sync-indicator.error {
            background: var(--danger);
        }

        .sync-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .sync-progress {
            width: 100%;
            height: 4px;
            background: var(--gray-200);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .sync-progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .cloud-sync {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .cloud-sync:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        /* Sistema de Relatórios Avançados */
        .reports-section {
            background: var(--gray-50);
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .reports-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .reports-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .report-filters {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--gray-200);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .filter-input {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .report-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .report-preview {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
            margin-bottom: 1.5rem;
        }

        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .summary-card {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .summary-label {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .report-table th,
        .report-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .report-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
        }

        .report-table tr:hover {
            background: var(--gray-50);
        }

        .report-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .chart-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 1rem;
        }

        .chart-container-report {
            position: relative;
            height: 300px;
        }

        .export-options {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .export-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            background: white;
            color: var(--gray-700);
            text-decoration: none;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .export-btn:hover {
            background: var(--gray-50);
            border-color: var(--primary);
            color: var(--primary);
        }

        .report-loading {
            text-align: center;
            padding: 2rem;
            color: var(--gray-500);
        }

        .report-empty {
            text-align: center;
            padding: 3rem;
            color: var(--gray-500);
        }

        .report-empty i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Sistema de Geolocalização */
        .location-section {
            background: var(--gray-50);
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .location-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .location-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .location-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .location-status.online {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .location-status.offline {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .location-map {
            width: 100%;
            height: 400px;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            margin-bottom: 1.5rem;
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
            font-size: 1.1rem;
        }

        .location-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .location-info {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
            margin-bottom: 1.5rem;
        }

        .location-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .location-detail {
            text-align: center;
        }

        .location-detail-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .location-detail-label {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .location-history {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
        }

        .location-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
            transition: background-color 0.2s ease;
        }

        .location-item:hover {
            background: var(--gray-50);
        }

        .location-item:last-child {
            border-bottom: none;
        }

        .location-item-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .location-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .location-item-details {
            flex: 1;
        }

        .location-item-address {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .location-item-time {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .location-item-distance {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 600;
        }

        .location-permission {
            text-align: center;
            padding: 2rem;
            color: var(--gray-500);
        }

        .location-permission i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .location-tracking {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 200px;
        }

        .location-tracking-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .location-tracking-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .location-tracking-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .location-tracking-coords {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* Sistema de Aprovação de Tarefas */
        .approval-section {
            background: var(--gray-50);
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .approval-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .approval-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .approval-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .approval-stat {
            background: white;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            text-align: center;
        }

        .approval-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .approval-stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .approval-queue {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
            margin-bottom: 1.5rem;
        }

        .approval-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
            transition: background-color 0.2s ease;
        }

        .approval-item:hover {
            background: var(--gray-50);
        }

        .approval-item:last-child {
            border-bottom: none;
        }

        .approval-item-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .approval-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .approval-item-details {
            flex: 1;
        }

        .approval-item-title {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .approval-item-meta {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .approval-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .approval-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .approval-badge.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .approval-badge.approved {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .approval-badge.rejected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .approval-modal {
            max-width: 800px;
        }

        .approval-form {
            padding: 1.5rem;
        }

        .approval-form-group {
            margin-bottom: 1.5rem;
        }

        .approval-form-label {
            display: block;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .approval-form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            resize: vertical;
            min-height: 100px;
        }

        .approval-form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .approval-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .approval-history {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
        }

        .approval-history-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .approval-history-item:last-child {
            border-bottom: none;
        }

        .approval-history-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .approval-history-details {
            flex: 1;
        }

        .approval-history-action {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .approval-history-meta {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .approval-history-time {
            font-size: 0.75rem;
            color: var(--gray-400);
        }

        /* Sistema de Histórico de Alterações */
        .history-section {
            background: var(--gray-50);
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .history-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .history-filters {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .history-filter {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            background: white;
            font-size: 0.875rem;
        }

        .history-timeline {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
        }

        .history-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--gray-100);
            position: relative;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 50px;
            bottom: -1rem;
            width: 2px;
            background: var(--gray-200);
        }

        .history-item:last-child::before {
            display: none;
        }

        .history-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            position: relative;
            z-index: 1;
        }

        .history-item-content {
            flex: 1;
        }

        .history-item-title {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .history-item-description {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .history-item-meta {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .history-item-changes {
            background: var(--gray-50);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .history-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .history-change:last-child {
            margin-bottom: 0;
        }

        .history-change-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .history-change-icon.added {
            background: var(--success);
            color: white;
        }

        .history-change-icon.modified {
            background: var(--warning);
            color: white;
        }

        .history-change-icon.removed {
            background: var(--danger);
            color: white;
        }

        .history-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .history-stat {
            background: white;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            text-align: center;
        }

        .history-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .history-stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        /* PRIORIDADE BADGES */
        .prioridade-baixa {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .prioridade-media {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .prioridade-alta {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .prioridade-urgente {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideInUp 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-500);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ORDENAÇÃO DE TABELAS */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }

        .sortable-header:hover {
            background-color: #f8f9fa;
        }

        .sort-asc {
            background-color: #e3f2fd !important;
        }

        .sort-desc {
            background-color: #e8f5e8 !important;
        }

        /* ESTILO PARA DICAS DE TECLADO */
        kbd {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            box-shadow: 0 1px 0 rgba(0,0,0,0.2);
            color: #495057;
            display: inline-block;
            font-size: 0.75em;
            font-weight: 700;
            line-height: 1;
            padding: 2px 4px;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <!-- ANIMATED BACKGROUND -->
    <div class="animated-bg"></div>
    <div class="floating-shapes">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>

    <!-- TELA DE LOGIN -->
    <div id="login-screen">
        <div class="header">
            <div class="container">
                <div class="header-content">
                    <h1><i class="fas fa-clipboard-check"></i> Tecno-Checklist Dinâmico</h1>
                    <p>Sistema Inteligente de Gestão de Infraestrutura</p>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="login-container">
                <div class="login-header">
                    <h2><i class="fas fa-rocket"></i> Acesso Rápido</h2>
                    <p>Entre com suas credenciais para acessar o sistema</p>
                </div>
                
                <form id="login-form">
                    <div class="form-group">
                        <label for="username">Usuário:</label>
                        <input type="text" id="username" required placeholder="Digite seu usuário" autocomplete="username">
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Senha:</label>
                        <input type="password" id="password" required placeholder="Digite sua senha" autocomplete="current-password">
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- APLICAÇÃO PRINCIPAL -->
    <div id="main-app" class="hidden">
        <div class="header">
            <div class="container">
                <div class="header-content">
                    <h1><i class="fas fa-clipboard-check"></i> Tecno-Checklist Dinâmico</h1>
                    <p>Bem-vindo, <span id="user-name">Usuário</span>! | 
                    <button onclick="logout()" class="btn btn-accent" style="padding: 0.5rem 1rem; font-size: 0.875rem; margin-left: 1rem;">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button></p>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="main-app">
                <div class="nav">
                    <button onclick="showSection('dashboard')" class="nav-btn active">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </button>
                    <button onclick="showSection('clientes')" class="nav-btn">
                        <i class="fas fa-users"></i>
                        <span>Clientes</span>
                    </button>
                    <button onclick="showSection('tecnicos')" class="nav-btn">
                        <i class="fas fa-tools"></i>
                        <span>Técnicos</span>
                    </button>
                    <button onclick="showSection('tipos')" class="nav-btn">
                        <i class="fas fa-tags"></i>
                        <span>Tipos</span>
                    </button>
                    <button onclick="showSection('tarefas')" class="nav-btn">
                        <i class="fas fa-tasks"></i>
                        <span>Tarefas</span>
                    </button>
                    <button onclick="showSection('usuarios')" class="nav-btn">
                        <i class="fas fa-user-cog"></i>
                        <span>Usuários</span>
                    </button>
                </div>

                <!-- DASHBOARD AVANÇADO -->
                <div id="dashboard" class="section active">
                    <h2 style="color: var(--primary); margin-bottom: 1.5rem; font-size: 2.5rem; font-weight: 800; text-align: center;">
                        <i class="fas fa-tachometer-alt"></i> Dashboard Inteligente
                    </h2>
                    
                    <!-- Métricas Principais -->
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-icon"><i class="fas fa-users"></i></div>
                            <div class="stat-value" id="total-clientes">0</div>
                            <div class="stat-label">Clientes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon"><i class="fas fa-user-tie"></i></div>
                            <div class="stat-value" id="total-tecnicos">0</div>
                            <div class="stat-label">Técnicos</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon"><i class="fas fa-tasks"></i></div>
                            <div class="stat-value" id="total-tarefas">0</div>
                            <div class="stat-label">Total de Tarefas</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="stat-value" id="tarefas-concluidas">0</div>
                            <div class="stat-label">Concluídas</div>
                        </div>
                    </div>

                    <!-- Gráficos e Análises -->
                    <div class="dashboard-grid">
                        <!-- Gráfico de Tarefas por Status -->
                        <div class="dashboard-card">
                            <h3><i class="fas fa-chart-pie"></i> Status das Tarefas</h3>
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>

                        <!-- Gráfico de Produtividade -->
                        <div class="dashboard-card">
                            <h3><i class="fas fa-chart-line"></i> Produtividade dos Técnicos</h3>
                            <div class="chart-container">
                                <canvas id="productivityChart"></canvas>
                            </div>
                        </div>

                        <!-- Gráfico de Tarefas por Período -->
                        <div class="dashboard-card">
                            <h3><i class="fas fa-chart-bar"></i> Tarefas por Período</h3>
                            <div class="chart-container">
                                <canvas id="timelineChart"></canvas>
                            </div>
                        </div>

                        <!-- Atividades Recentes -->
                        <div class="dashboard-card">
                            <h3><i class="fas fa-history"></i> Atividades Recentes</h3>
                            <div class="recent-activities" id="recent-activities">
                                <!-- Atividades serão carregadas dinamicamente -->
                            </div>
                        </div>

                        <!-- Métricas de Performance -->
                        <div class="dashboard-card">
                            <h3><i class="fas fa-trophy"></i> Performance</h3>
                            <div class="metric-card">
                                <div class="metric-value" id="avg-completion-time">0h</div>
                                <div class="metric-label">Tempo Médio de Conclusão</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="success-rate">0%</div>
                                <div class="metric-label">Taxa de Sucesso</div>
                            </div>
                        </div>

                        <!-- Notificações -->
                        <div class="dashboard-card">
                            <h3><i class="fas fa-bell"></i> Notificações</h3>
                            <div id="notifications-list">
                                <!-- Notificações serão carregadas dinamicamente -->
                            </div>
                        </div>

                        <!-- Sistema de Backup -->
                        <div class="dashboard-card">
                            <h3><i class="fas fa-cloud-upload-alt"></i> Backup & Sincronização</h3>
                            <div class="backup-stats">
                                <div class="backup-stat">
                                    <div class="backup-stat-value" id="backup-count">0</div>
                                    <div class="backup-stat-label">Backups</div>
                                </div>
                                <div class="backup-stat">
                                    <div class="backup-stat-value" id="last-backup">-</div>
                                    <div class="backup-stat-label">Último Backup</div>
                                </div>
                                <div class="backup-stat">
                                    <div class="backup-stat-value" id="sync-status">Online</div>
                                    <div class="backup-stat-label">Status</div>
                                </div>
                            </div>
                            <div class="backup-actions">
                                <button onclick="createBackup()" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Criar Backup
                                </button>
                                <button onclick="restoreBackup()" class="btn btn-secondary">
                                    <i class="fas fa-undo"></i> Restaurar
                                </button>
                                <button onclick="exportData()" class="btn btn-success">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                                <button onclick="importData()" class="btn btn-info">
                                    <i class="fas fa-upload"></i> Importar
                                </button>
                            </div>
                        </div>

                        <!-- Sistema de Relatórios -->
                        <div class="dashboard-card">
                            <h3><i class="fas fa-chart-bar"></i> Relatórios Avançados</h3>
                            <div class="report-actions">
                                <button onclick="generateReport('tarefas')" class="btn btn-primary">
                                    <i class="fas fa-tasks"></i> Relatório de Tarefas
                                </button>
                                <button onclick="generateReport('produtividade')" class="btn btn-success">
                                    <i class="fas fa-chart-line"></i> Produtividade
                                </button>
                                <button onclick="generateReport('clientes')" class="btn btn-info">
                                    <i class="fas fa-users"></i> Relatório de Clientes
                                </button>
                                <button onclick="showReportFilters()" class="btn btn-secondary">
                                    <i class="fas fa-filter"></i> Filtros Avançados
                                </button>
                            </div>
                            <div class="export-options">
                                <a href="#" onclick="exportReport('excel')" class="export-btn">
                                    <i class="fas fa-file-excel"></i> Excel
                                </a>
                                <a href="#" onclick="exportReport('csv')" class="export-btn">
                                    <i class="fas fa-file-csv"></i> CSV
                                </a>
                            </div>
                        </div>

                        <!-- Sistema de Geolocalização -->
                        <div class="dashboard-card">
                            <h3><i class="fas fa-map-marker-alt"></i> Geolocalização</h3>
                            <div class="location-details">
                                <div class="location-detail">
                                    <div class="location-detail-value" id="current-location">-</div>
                                    <div class="location-detail-label">Localização Atual</div>
                                </div>
                                <div class="location-detail">
                                    <div class="location-detail-value" id="location-accuracy">-</div>
                                    <div class="location-detail-label">Precisão (m)</div>
                                </div>
                                <div class="location-detail">
                                    <div class="location-detail-value" id="location-status">Offline</div>
                                    <div class="location-detail-label">Status</div>
                                </div>
                            </div>
                            <div class="location-controls">
                                <button onclick="requestLocationPermission()" class="btn btn-primary">
                                    <i class="fas fa-location-arrow"></i> Ativar Localização
                                </button>
                                <button onclick="showLocationHistory()" class="btn btn-secondary">
                                    <i class="fas fa-history"></i> Histórico
                                </button>
                                <button onclick="showLocationMap()" class="btn btn-info">
                                    <i class="fas fa-map"></i> Ver Mapa
                                </button>
                            </div>
                        </div>

                        <!-- Sistema de Aprovação -->
                        <div class="dashboard-card">
                            <h3><i class="fas fa-check-circle"></i> Aprovação de Tarefas</h3>
                            <div class="approval-stats">
                                <div class="approval-stat">
                                    <div class="approval-stat-value" id="pending-approvals">0</div>
                                    <div class="approval-stat-label">Pendentes</div>
                                </div>
                                <div class="approval-stat">
                                    <div class="approval-stat-value" id="approved-today">0</div>
                                    <div class="approval-stat-label">Aprovadas Hoje</div>
                                </div>
                                <div class="approval-stat">
                                    <div class="approval-stat-value" id="rejected-today">0</div>
                                    <div class="approval-stat-label">Rejeitadas Hoje</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <button onclick="showApprovalQueue()" class="btn btn-primary">
                                    <i class="fas fa-list"></i> Fila de Aprovação
                                </button>
                                <button onclick="showApprovalHistory()" class="btn btn-secondary">
                                    <i class="fas fa-history"></i> Histórico
                                </button>
                                <button onclick="showApprovalSettings()" class="btn btn-info">
                                    <i class="fas fa-cog"></i> Configurações
                                </button>
                            </div>
                        </div>

                        <!-- Sistema de Histórico -->
                        <div class="dashboard-card">
                            <h3><i class="fas fa-history"></i> Histórico de Alterações</h3>
                            <div class="history-stats">
                                <div class="history-stat">
                                    <div class="history-stat-value" id="total-changes">0</div>
                                    <div class="history-stat-label">Total de Alterações</div>
                                </div>
                                <div class="history-stat">
                                    <div class="history-stat-value" id="changes-today">0</div>
                                    <div class="history-stat-label">Hoje</div>
                                </div>
                                <div class="history-stat">
                                    <div class="history-stat-value" id="active-users">0</div>
                                    <div class="history-stat-label">Usuários Ativos</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <button onclick="showHistoryTimeline()" class="btn btn-primary">
                                    <i class="fas fa-timeline"></i> Linha do Tempo
                                </button>
                                <button onclick="showHistoryFilters()" class="btn btn-secondary">
                                    <i class="fas fa-filter"></i> Filtros
                                </button>
                                <button onclick="exportHistory()" class="btn btn-info">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CLIENTES -->
                <div id="clientes" class="section">
                    <h2 style="color: var(--primary); margin-bottom: 1.5rem; font-size: 2.5rem; font-weight: 800; text-align: center;">
                        <i class="fas fa-users"></i> Gestão de Clientes
                    </h2>
                    
                    <!-- FORMULÁRIO DE CLIENTE -->
                    <div class="feature-card" style="margin-bottom: 2rem;">
                        <h3><i class="fas fa-user-plus"></i> Cadastrar Novo Cliente</h3>
                        <form id="cliente-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div class="form-group">
                                <label for="cliente-nome">Nome da Empresa:</label>
                                <input type="text" id="cliente-nome" required placeholder="Digite o nome da empresa" onkeypress="handleEnter(event, 'cliente-cnpj')" onblur="validateField(this, 'required')">
                            </div>
                            <div class="form-group">
                                <label for="cliente-cnpj">CNPJ: <span id="cnpj-status" style="font-size: 12px; color: #6b7280;"></span></label>
                                <input type="text" id="cliente-cnpj" placeholder="00.000.000/0000-00" maxlength="18" onkeypress="handleEnter(event, 'cliente-whatsapp')" onblur="validateField(this, 'cnpj')">
                                <small style="color: #6b7280; font-size: 11px;">Digite o CNPJ completo para buscar dados automaticamente via BrasilAPI, CNPJ.wj ou ReceitaWS</small>
                            </div>
                            <div class="form-group">
                                <label for="cliente-whatsapp">WhatsApp:</label>
                                <input type="text" id="cliente-whatsapp" required placeholder="(00) 00000-0000" onkeypress="handleEnter(event, 'cliente-endereco')" onblur="validateField(this, 'phone')">
                            </div>
                            <div class="form-group">
                                <label for="cliente-endereco">Endereço:</label>
                                <input type="text" id="cliente-endereco" required placeholder="Rua, Avenida, etc." onkeypress="handleEnter(event, 'cliente-bairro')" onblur="validateField(this, 'required')">
                            </div>
                            <div class="form-group">
                                <label for="cliente-bairro">Bairro:</label>
                                <input type="text" id="cliente-bairro" required placeholder="Nome do bairro" onkeypress="handleEnter(event, 'cliente-cidade')" onblur="validateField(this, 'required')">
                            </div>
                            <div class="form-group">
                                <label for="cliente-cidade">Cidade:</label>
                                <input type="text" id="cliente-cidade" required placeholder="Nome da cidade" onkeypress="handleEnter(event, 'cliente-cep')" onblur="validateField(this, 'required')">
                            </div>
                            <div class="form-group">
                                <label for="cliente-cep">CEP:</label>
                                <input type="text" id="cliente-cep" required placeholder="00000-000" maxlength="9" onkeypress="handleEnter(event, 'btn-salvar-cliente')" onblur="validateField(this, 'cep')">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <button type="submit" id="btn-salvar-cliente" class="btn btn-success" style="width: 100%;">
                                    <i class="fas fa-plus"></i> Adicionar Cliente
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- LISTA DE CLIENTES -->
                    <div class="feature-card">
                        <h3><i class="fas fa-list"></i> Clientes Cadastrados</h3>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" id="search-clientes" placeholder="🔍 Buscar clientes..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" onkeyup="searchTable('clientes', this.value)">
                        </div>
                        <div style="overflow-x: auto; margin-top: 1rem;">
                            <table class="table" id="clientes-table">
                                <thead>
                                    <tr>
                                        <th class="sortable-header" onclick="sortTable('clientes-table', 0)">Nome</th>
                                        <th class="sortable-header" onclick="sortTable('clientes-table', 1)">CNPJ</th>
                                        <th class="sortable-header" onclick="sortTable('clientes-table', 2)">WhatsApp</th>
                                        <th class="sortable-header" onclick="sortTable('clientes-table', 3)">Endereço</th>
                                        <th class="sortable-header" onclick="sortTable('clientes-table', 4)">Bairro</th>
                                        <th class="sortable-header" onclick="sortTable('clientes-table', 5)">Cidade</th>
                                        <th class="sortable-header" onclick="sortTable('clientes-table', 6)">CEP</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TÉCNICOS -->
                <div id="tecnicos" class="section">
                    <h2 style="color: var(--primary); margin-bottom: 1.5rem; font-size: 2.5rem; font-weight: 800; text-align: center;">
                        <i class="fas fa-tools"></i> Equipe Técnica
                    </h2>
                    
                    <!-- FORMULÁRIO DE TÉCNICO -->
                    <div class="feature-card" style="margin-bottom: 2rem;">
                        <h3><i class="fas fa-user-plus"></i> Cadastrar Novo Técnico</h3>
                        <form id="tecnico-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div class="form-group">
                                <label for="tecnico-nome">Nome Completo:</label>
                                <input type="text" id="tecnico-nome" required placeholder="Digite o nome completo" onkeypress="handleEnter(event, 'tecnico-especialidade')">
                            </div>
                            <div class="form-group">
                                <label for="tecnico-especialidade">Especialidade:</label>
                                <input type="text" id="tecnico-especialidade" required placeholder="Ex: Eletricista, Mecânico, Hidráulico..." onkeypress="handleEnter(event, 'tecnico-telefone')">
                            </div>
                            <div class="form-group">
                                <label for="tecnico-telefone">Telefone:</label>
                                <input type="text" id="tecnico-telefone" required placeholder="(11) 99999-9999" onkeypress="handleEnter(event, 'tecnico-email')">
                            </div>
                            <div class="form-group">
                                <label for="tecnico-email">E-mail:</label>
                                <input type="email" id="tecnico-email" placeholder="tecnico@empresa.com" onkeypress="handleEnter(event, 'btn-salvar-tecnico')" onblur="validateField(this, 'email')">
                            </div>
                            <div class="form-group">
                                <label for="tecnico-status">Status:</label>
                                <select id="tecnico-status" required>
                                    <option value="ativo">Ativo</option>
                                    <option value="inativo">Inativo</option>
                                    <option value="ferias">Férias</option>
                                    <option value="licenca">Licença</option>
                                </select>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <button type="submit" id="btn-salvar-tecnico" class="btn btn-success" style="width: 100%;">
                                    <i class="fas fa-plus"></i> Adicionar Técnico
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- LISTA DE TÉCNICOS -->
                    <div class="feature-card">
                        <h3><i class="fas fa-list"></i> Técnicos Cadastrados</h3>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" id="search-tecnicos" placeholder="🔍 Buscar técnicos..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" onkeyup="searchTable('tecnicos', this.value)">
                        </div>
                        <div style="overflow-x: auto; margin-top: 1rem;">
                            <table class="table" id="tecnicos-table">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Especialidade</th>
                                        <th>Telefone</th>
                                        <th>E-mail</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TIPOS -->
                <div id="tipos" class="section">
                    <h2 style="color: var(--primary); margin-bottom: 1.5rem; font-size: 2.5rem; font-weight: 800; text-align: center;">
                        <i class="fas fa-tags"></i> Tipos de Serviço
                    </h2>

                    
                    <!-- FORMULÁRIO DE TIPO -->
                    <div class="feature-card" style="margin-bottom: 2rem;">
                        <h3><i class="fas fa-plus-circle"></i> Criar Novo Tipo de Serviço</h3>
                        <form id="tipo-form" style="margin-top: 1rem;">
                            <div class="form-group">
                                <label for="tipo-nome">Nome do Serviço:</label>
                                <input type="text" id="tipo-nome" required placeholder="Ex: Manutenção de Bomba" onkeypress="handleEnter(event, 'tipo-descricao')">
                            </div>
                            <div class="form-group">
                                <label for="tipo-descricao">Descrição:</label>
                                <textarea id="tipo-descricao" placeholder="Descreva o tipo de serviço" rows="3" onkeypress="handleTextareaEnter(event, 'tipo-checklist')"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="tipo-checklist">Checklist (um item por linha):</label>
                                <textarea id="tipo-checklist" placeholder="Item 1&#10;Item 2&#10;Item 3" rows="5" onkeypress="handleTextareaEnter(event, 'btn-salvar-tipo')"></textarea>
                                <small style="color: #6c757d; font-size: 0.8rem;">
                                    💡 <strong>Dica:</strong> Use <kbd>Shift + Enter</kbd> para nova linha ou <kbd>Enter</kbd> para salvar
                                </small>
                            </div>
                            <div class="form-group">
                                <button type="submit" id="btn-salvar-tipo" class="btn btn-success" style="width: 100%;">
                                    <i class="fas fa-plus"></i> Criar Tipo de Serviço
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- LISTA DE TIPOS -->
                    <div class="feature-card">
                        <h3><i class="fas fa-list"></i> Tipos de Serviço Cadastrados</h3>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" id="search-tipos" placeholder="🔍 Buscar tipos..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" onkeyup="searchTable('tipos', this.value)">
                        </div>
                        <div style="overflow-x: auto; margin-top: 1rem;">
                            <table class="table" id="tipos-table">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Descrição</th>
                                        <th>Itens do Checklist</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAREFAS -->
                <div id="tarefas" class="section">
                    <h2 style="color: var(--primary); margin-bottom: 1.5rem; font-size: 2.5rem; font-weight: 800; text-align: center;">
                        <i class="fas fa-tasks"></i> Gestão de Tarefas
                    </h2>
                    
                    <!-- FORMULÁRIO DE TAREFA -->
                    <div class="feature-card" style="margin-bottom: 2rem;">
                        <h3><i class="fas fa-plus-circle"></i> Criar Nova Tarefa</h3>
                        <form id="tarefa-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div class="form-group">
                                <label for="tarefa-titulo">Título da Tarefa:</label>
                                <input type="text" id="tarefa-titulo" required placeholder="Digite o título da tarefa" onkeypress="handleEnter(event, 'tarefa-cliente')">
                            </div>
                            <div class="form-group">
                                <label for="tarefa-cliente">Cliente:</label>
                                <select id="tarefa-cliente" required onkeypress="handleEnter(event, 'tarefa-tecnico')">
                                    <option value="">Selecione o cliente</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="tarefa-tecnico">Técnico:</label>
                                <select id="tarefa-tecnico" required onkeypress="handleEnter(event, 'tarefa-tipo')">
                                    <option value="">Selecione o técnico</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="tarefa-tipo">Tipo de Serviço:</label>
                                <select id="tarefa-tipo" required onkeypress="handleEnter(event, 'tarefa-data')">
                                    <option value="">Selecione o tipo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="tarefa-data">Data:</label>
                                <input type="date" id="tarefa-data" required onkeypress="handleEnter(event, 'tarefa-prioridade')">
                            </div>
                            <div class="form-group">
                                <label for="tarefa-prioridade">Prioridade:</label>
                                <select id="tarefa-prioridade" required onkeypress="handleEnter(event, 'tarefa-observacoes')">
                                    <option value="baixa">Baixa</option>
                                    <option value="media">Média</option>
                                    <option value="alta">Alta</option>
                                    <option value="urgente">Urgente</option>
                                </select>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="tarefa-observacoes">Observações:</label>
                                <textarea id="tarefa-observacoes" placeholder="Observações adicionais" rows="3" onkeypress="handleTextareaEnter(event, 'btn-salvar-tarefa')"></textarea>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <button type="submit" id="btn-salvar-tarefa" class="btn btn-success" style="width: 100%;">
                                    <i class="fas fa-plus"></i> Criar Tarefa
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- BUSCA E FILTROS -->
                    <div class="feature-card" style="margin-bottom: 2rem;">
                        <h3><i class="fas fa-search"></i> Busca e Filtros Avançados</h3>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" id="search-tarefas" placeholder="🔍 Buscar tarefas..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" onkeyup="searchTable('tarefas', this.value)">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <div class="form-group">
                                <label for="busca-tarefas">Buscar tarefas:</label>
                                <input type="text" id="busca-tarefas" placeholder="Digite o título, cliente, técnico ou observações..." 
                                       onkeyup="buscarTarefas()" style="width: 100%;">
                            </div>
                        </div>
                        <div class="filtros-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div class="form-group">
                                <label for="filtro-cliente">Cliente:</label>
                                <select id="filtro-cliente" onchange="aplicarFiltros()">
                                    <option value="">Todos os clientes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filtro-tecnico">Técnico:</label>
                                <select id="filtro-tecnico" onchange="aplicarFiltros()">
                                    <option value="">Todos os técnicos</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filtro-status">Status:</label>
                                <select id="filtro-status" onchange="aplicarFiltros()">
                                    <option value="">Todos os status</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="em-andamento">Em Andamento</option>
                                    <option value="concluida">Concluída</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filtro-prioridade">Prioridade:</label>
                                <select id="filtro-prioridade" onchange="aplicarFiltros()">
                                    <option value="">Todas as prioridades</option>
                                    <option value="baixa">Baixa</option>
                                    <option value="media">Média</option>
                                    <option value="alta">Alta</option>
                                    <option value="urgente">Urgente</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-info" onclick="aplicarFiltros()" style="width: 100%;">
                                    <i class="fas fa-search"></i> Filtrar
                                </button>
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-secondary" onclick="limparFiltros()" style="width: 100%;">
                                    <i class="fas fa-times"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- LISTA DE TAREFAS -->
                    <div class="feature-card">
                        <h3><i class="fas fa-list"></i> Tarefas Cadastradas</h3>
                        <div style="overflow-x: auto; margin-top: 1rem;">
                            <table class="table" id="tarefas-table">
                                <thead>
                                    <tr>
                                        <th>Título</th>
                                        <th>Cliente</th>
                                        <th>Técnico</th>
                                        <th>Tipo</th>
                                        <th>Data</th>
                                        <th>Prioridade</th>
                                        <th>Status</th>
                                        <th>Progresso</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tarefas-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- USUÁRIOS -->
                <div id="usuarios" class="section">
                    <h2 style="color: var(--primary); margin-bottom: 1.5rem; font-size: 2.5rem; font-weight: 800; text-align: center;">
                        <i class="fas fa-user-cog"></i> Gestão de Usuários
                    </h2>
                    
                    <!-- FORMULÁRIO DE USUÁRIO -->
                    <div class="feature-card" style="margin-bottom: 2rem;">
                        <h3><i class="fas fa-user-plus"></i> Cadastrar Novo Usuário</h3>
                        <form id="usuario-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div class="form-group">
                                <label for="usuario-nome">Nome Completo:</label>
                                <input type="text" id="usuario-nome" required placeholder="Digite o nome completo" onkeypress="handleEnter(event, 'usuario-login')">
                            </div>
                            <div class="form-group">
                                <label for="usuario-login">Usuário:</label>
                                <input type="text" id="usuario-login" required placeholder="Nome de usuário" onkeypress="handleEnter(event, 'usuario-senha')">
                            </div>
                            <div class="form-group">
                                <label for="usuario-senha">Senha:</label>
                                <input type="password" id="usuario-senha" required placeholder="Digite a senha" onkeypress="handleEnter(event, 'usuario-perfil')">
                            </div>
                            <div class="form-group">
                                <label for="usuario-perfil">Perfil:</label>
                                <select id="usuario-perfil" required onkeypress="handleEnter(event, 'usuario-ativo')">
                                    <option value="">Selecione o perfil</option>
                                    <option value="admin">Administrador</option>
                                    <option value="operador">Operador</option>
                                    <option value="visualizador">Visualizador</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="usuario-ativo">Status:</label>
                                <select id="usuario-ativo" required onkeypress="handleEnter(event, 'btn-salvar-usuario')">
                                    <option value="true">Ativo</option>
                                    <option value="false">Inativo</option>
                                </select>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <button type="submit" id="btn-salvar-usuario" class="btn btn-success" style="width: 100%;">
                                    <i class="fas fa-plus"></i> Cadastrar Usuário
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- LISTA DE USUÁRIOS -->
                    <div class="feature-card">
                        <h3><i class="fas fa-list"></i> Usuários Cadastrados</h3>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" id="search-usuarios" placeholder="🔍 Buscar usuários..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" onkeyup="searchTable('usuarios', this.value)">
                        </div>
                        <div style="overflow-x: auto; margin-top: 1rem;">
                            <table class="table" id="usuarios-table">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Usuário</th>
                                        <th>Perfil</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Container de Notificações -->
    <div class="notification-container" id="notification-container"></div>

    <!-- Status de Sincronização -->
    <div class="sync-status" id="sync-status-widget" style="display: none;">
        <div class="sync-status-header">
            <div class="sync-indicator" id="sync-indicator"></div>
            <span class="sync-text" id="sync-text">Sincronizado</span>
        </div>
        <div class="sync-progress" id="sync-progress" style="display: none;">
            <div class="sync-progress-bar" id="sync-progress-bar"></div>
        </div>
    </div>

    <!-- Widget de Rastreamento de Localização -->
    <div class="location-tracking" id="location-tracking-widget" style="display: none;">
        <div class="location-tracking-header">
            <div class="location-tracking-status" id="location-tracking-indicator"></div>
            <span class="location-tracking-text" id="location-tracking-text">Rastreando</span>
        </div>
        <div class="location-tracking-coords" id="location-tracking-coords">-</div>
    </div>

    <script>
        // DADOS GLOBAIS
        let currentUser = null;
        let usuarios = [
            { id: 1, usuario: 'admin', senha: '123', nome: 'Administrador', perfil: 'admin', ativo: true },
            { id: 2, usuario: 'operador', senha: '123', nome: 'Operador', perfil: 'operador', ativo: true },
            { id: 3, usuario: 'visualizador', senha: '123', nome: 'Visualizador', perfil: 'visualizador', ativo: true }
        ];
        let clientes = [];
        let tecnicos = [];
        let tipos = [];
        let tarefas = [];
        let editingClienteId = null;
        let editingTecnicoId = null;
        let editingTipoNome = null;
        let editingUsuarioId = null;

        // INICIALIZAÇÃO
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadData();
            updateStats();
            startAnimations();
        });

        function setupEventListeners() {
            // Login
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // Clientes
            document.getElementById('cliente-form').addEventListener('submit', handleClienteSubmit);
            
            // Técnicos
            document.getElementById('tecnico-form').addEventListener('submit', handleTecnicoSubmit);
            
            // Tipos
            document.getElementById('tipo-form').addEventListener('submit', handleTipoSubmit);
            
            // Tarefas
            document.getElementById('tarefa-form').addEventListener('submit', handleTarefaSubmit);
            
            // Usuários
            document.getElementById('usuario-form').addEventListener('submit', handleUsuarioSubmit);
            
            // Formatação de CNPJ
            document.getElementById('cliente-cnpj').addEventListener('input', formatCNPJ);
            
            // Formatação de telefone
            document.getElementById('cliente-whatsapp').addEventListener('input', formatPhone);
            document.getElementById('tecnico-telefone').addEventListener('input', formatPhone);
            
            // Formatação de CEP
            document.getElementById('cliente-cep').addEventListener('input', formatCEP);
        }

        // LOGIN
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loading"></div> Entrando...';
            btn.disabled = true;
            
            setTimeout(() => {
                const user = usuarios.find(u => u.usuario === username && u.senha === password);
                if (user) {
                    currentUser = user;
                    showMainApp();
                } else {
                    showNotification('❌ Usuário ou senha incorretos!', 'error');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }, 1500);
        }

        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('user-name').textContent = currentUser.nome;
            showSection('dashboard');
            showNotification('✅ Login realizado com sucesso!', 'success');
            updateSelects();
        }

        function showSection(sectionName) {
            // Otimização: usar uma única query para ambos os seletores
            const allSections = document.querySelectorAll('.section, .nav-btn');
            allSections.forEach(element => {
                element.classList.remove('active');
            });
            
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            const activeBtn = event?.target || document.querySelector(`[onclick="showSection('${sectionName}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // Atualizar dados quando mudar de seção
            if (sectionName === 'dashboard') {
                updateStats();
            } else if (sectionName === 'clientes') {
                renderClientes();
            } else if (sectionName === 'tecnicos') {
                renderTecnicos();
            } else if (sectionName === 'tipos') {
                renderTipos();
            } else if (sectionName === 'tarefas') {
                renderTarefas();
            } else if (sectionName === 'usuarios') {
                renderUsuarios();
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
            showNotification('👋 Logout realizado com sucesso!', 'info');
        }

        // CLIENTES
        async function handleClienteSubmit(e) {
            e.preventDefault();
            
            // Validar formulário antes de submeter
            if (!validateForm('cliente-form')) {
                showNotification('❌ Por favor, corrija os erros no formulário!', 'error');
                return;
            }
            
            const nome = document.getElementById('cliente-nome').value;
            const cnpj = document.getElementById('cliente-cnpj').value;
            const whatsapp = document.getElementById('cliente-whatsapp').value;
            const endereco = document.getElementById('cliente-endereco').value;
            const bairro = document.getElementById('cliente-bairro').value;
            const cidade = document.getElementById('cliente-cidade').value;
            const cep = document.getElementById('cliente-cep').value;
            
            if (editingClienteId) {
                // Editar cliente existente
                const index = clientes.findIndex(c => c.id === editingClienteId);
                if (index !== -1) {
                    clientes[index] = {
                        ...clientes[index],
                        nome, cnpj, whatsapp, endereco, bairro, cidade, cep
                    };
                    showNotification('✅ Cliente atualizado com sucesso!', 'success');
                }
                editingClienteId = null;
            } else {
                // Adicionar novo cliente
                const novoCliente = {
                    id: crypto.randomUUID(),
                    nome, cnpj, whatsapp, endereco, bairro, cidade, cep, ativo: true
                };
                clientes.push(novoCliente);
                showNotification('✅ Cliente adicionado com sucesso!', 'success');
            }
            
            await saveData();
            document.getElementById('cliente-form').reset();
            renderClientes();
            updateStats();
            updateSelects();
        }

        function renderClientes() {
            const tbody = document.querySelector('#clientes-table tbody');
            tbody.innerHTML = '';
            
            clientes.forEach(cliente => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${cliente.nome}</td>
                    <td>${cliente.cnpj || '-'}</td>
                    <td>${cliente.whatsapp || '-'}</td>
                    <td>${cliente.endereco || '-'}</td>
                    <td>${cliente.bairro || '-'}</td>
                    <td>${cliente.cidade || '-'}</td>
                    <td>${cliente.cep || '-'}</td>
                    <td>
                        <button onclick="editCliente('${cliente.id}')" class="btn btn-info btn-sm">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button onclick="deleteCliente('${cliente.id}')" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editCliente(id) {
            const cliente = clientes.find(c => c.id === id);
            if (cliente) {
                editingClienteId = id;
                document.getElementById('cliente-nome').value = cliente.nome;
                document.getElementById('cliente-cnpj').value = cliente.cnpj || '';
                document.getElementById('cliente-whatsapp').value = cliente.whatsapp || '';
                document.getElementById('cliente-endereco').value = cliente.endereco || '';
                document.getElementById('cliente-bairro').value = cliente.bairro || '';
                document.getElementById('cliente-cidade').value = cliente.cidade || '';
                document.getElementById('cliente-cep').value = cliente.cep || '';
                
                const btn = document.querySelector('#cliente-form button[type="submit"]');
                btn.innerHTML = '<i class="fas fa-save"></i> Atualizar Cliente';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-warning');
            }
        }

        async function deleteCliente(id) {
            const cliente = clientes.find(c => c.id === id);
            if (!cliente) return;
            
            showConfirmModal(
                'Excluir Cliente',
                `Tem certeza que deseja excluir o cliente <strong>"${cliente.nome}"</strong>?<br><br>Esta ação não pode ser desfeita.`,
                async () => {
                    try {
                        // Deletar do Supabase
                        await fetch(`/api/deleteData?tabela=clientes&id=${id}`, {
                            method: 'DELETE'
                        });
                        
                        // Remover da lista local
                        clientes = clientes.filter(c => c.id !== id);
                        renderClientes();
                        updateStats();
                        updateSelects();
                        showNotification('✅ Cliente excluído com sucesso!', 'success');
                    } catch (error) {
                        console.error('Erro ao deletar cliente:', error);
                        showNotification('❌ Erro ao excluir cliente!', 'error');
                    }
                }
            );
        }

        // TÉCNICOS
        function handleTecnicoSubmit(e) {
            e.preventDefault();
            
            const nome = document.getElementById('tecnico-nome').value;
            const especialidade = document.getElementById('tecnico-especialidade').value;
            const telefone = document.getElementById('tecnico-telefone').value;
            const email = document.getElementById('tecnico-email').value;
            const status = document.getElementById('tecnico-status').value;
            
            if (editingTecnicoId) {
                const index = tecnicos.findIndex(t => t.id === editingTecnicoId);
                if (index !== -1) {
                    tecnicos[index] = { ...tecnicos[index], nome, especialidade, telefone, email, status };
                    showNotification('✅ Técnico atualizado com sucesso!', 'success');
                }
                editingTecnicoId = null;
            } else {
                const novoTecnico = {
                    id: crypto.randomUUID(),
                    nome, especialidade, telefone, email, status
                };
                tecnicos.push(novoTecnico);
                showNotification('✅ Técnico adicionado com sucesso!', 'success');
            }
            
            saveData();
            document.getElementById('tecnico-form').reset();
            renderTecnicos();
            updateStats();
            updateSelects();
        }

        function renderTecnicos() {
            const tbody = document.querySelector('#tecnicos-table tbody');
            tbody.innerHTML = '';
            
            tecnicos.forEach(tecnico => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${tecnico.nome}</td>
                    <td>${tecnico.especialidade}</td>
                    <td>${tecnico.telefone}</td>
                    <td>${tecnico.email || '-'}</td>
                    <td><span class="status-${tecnico.status}">${tecnico.status}</span></td>
                    <td>
                        <button onclick="editTecnico('${tecnico.id}')" class="btn btn-info btn-sm">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button onclick="deleteTecnico('${tecnico.id}')" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editTecnico(id) {
            const tecnico = tecnicos.find(t => t.id === id);
            if (tecnico) {
                editingTecnicoId = id;
                document.getElementById('tecnico-nome').value = tecnico.nome;
                document.getElementById('tecnico-especialidade').value = tecnico.especialidade;
                document.getElementById('tecnico-telefone').value = tecnico.telefone;
                document.getElementById('tecnico-email').value = tecnico.email || '';
                document.getElementById('tecnico-status').value = tecnico.status;
                
                const btn = document.querySelector('#tecnico-form button[type="submit"]');
                btn.innerHTML = '<i class="fas fa-save"></i> Atualizar Técnico';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-warning');
            }
        }

        async function deleteTecnico(id) {
            const tecnico = tecnicos.find(t => t.id === id);
            if (!tecnico) return;
            
            showConfirmModal(
                'Excluir Técnico',
                `Tem certeza que deseja excluir o técnico <strong>"${tecnico.nome}"</strong>?<br><br>Esta ação não pode ser desfeita.`,
                async () => {
                    try {
                        // Deletar do Supabase
                        await fetch(`/api/deleteData?tabela=tecnicos&id=${id}`, {
                            method: 'DELETE'
                        });
                        
                        // Remover da lista local
                        tecnicos = tecnicos.filter(t => t.id !== id);
                        renderTecnicos();
                        updateSelects();
                        showNotification('✅ Técnico excluído com sucesso!', 'success');
                    } catch (error) {
                        console.error('Erro ao deletar técnico:', error);
                        showNotification('❌ Erro ao excluir técnico!', 'error');
                    }
                }
            );
        }

        // TIPOS
        function handleTipoSubmit(e) {
            e.preventDefault();
            
            const nome = document.getElementById('tipo-nome').value;
            const descricao = document.getElementById('tipo-descricao').value;
            const checklist = document.getElementById('tipo-checklist').value.split('\n').filter(item => item.trim());
            
            if (editingTipoNome) {
                const index = tipos.findIndex(t => t.nome === editingTipoNome);
                if (index !== -1) {
                    tipos[index] = { ...tipos[index], nome, descricao, checklist };
                    showNotification('✅ Tipo atualizado com sucesso!', 'success');
                }
                editingTipoNome = null;
            } else {
                const novoTipo = {
                    nome, descricao, checklist
                };
                tipos.push(novoTipo);
                showNotification('✅ Tipo adicionado com sucesso!', 'success');
            }
            
            saveData();
            document.getElementById('tipo-form').reset();
            renderTipos();
            updateStats();
            updateSelects();
        }

        function renderTipos() {
            const tbody = document.querySelector('#tipos-table tbody');
            tbody.innerHTML = '';
            
            tipos.forEach(tipo => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${tipo.nome}</td>
                    <td>${tipo.descricao || '-'}</td>
                    <td>${tipo.checklist.length} itens</td>
                    <td>
                        <button onclick="editTipo('${tipo.nome}')" class="btn btn-info btn-sm">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button onclick="deleteTipo('${tipo.nome}')" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editTipo(nome) {
            const tipo = tipos.find(t => t.nome === nome);
            if (tipo) {
                editingTipoNome = nome;
                document.getElementById('tipo-nome').value = tipo.nome;
                document.getElementById('tipo-descricao').value = tipo.descricao || '';
                document.getElementById('tipo-checklist').value = tipo.checklist.join('\n');
                
                const btn = document.querySelector('#tipo-form button[type="submit"]');
                btn.innerHTML = '<i class="fas fa-save"></i> Atualizar Tipo';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-warning');
            }
        }

        async function deleteTipo(nome) {
            const tipo = tipos.find(t => t.nome === nome);
            if (!tipo) return;
            
            showConfirmModal(
                'Excluir Tipo de Serviço',
                `Tem certeza que deseja excluir o tipo <strong>"${nome}"</strong>?<br><br>Esta ação não pode ser desfeita.`,
                async () => {
                    try {
                        // Deletar do Supabase
                        await fetch(`/api/deleteData?tabela=tipos_tarefa&id=${tipo.id}`, {
                            method: 'DELETE'
                        });
                        
                        // Remover da lista local
                        tipos = tipos.filter(t => t.nome !== nome);
                        renderTipos();
                        updateSelects();
                        showNotification('✅ Tipo excluído com sucesso!', 'success');
                    } catch (error) {
                        console.error('Erro ao deletar tipo:', error);
                        showNotification('❌ Erro ao excluir tipo!', 'error');
                    }
                }
            );
        }

        // TAREFAS
        function handleTarefaSubmit(e) {
            e.preventDefault();
            
            const titulo = document.getElementById('tarefa-titulo').value;
            const cliente_id = document.getElementById('tarefa-cliente').value; // Agora é UUID
            const tecnico_id = document.getElementById('tarefa-tecnico').value; // Agora é UUID
            const tipo_id = document.getElementById('tarefa-tipo').value; // Agora é UUID
            const data = document.getElementById('tarefa-data').value;
            const prioridade = document.getElementById('tarefa-prioridade').value;
            const observacoes = document.getElementById('tarefa-observacoes').value;
            
            // Validar se cliente, técnico e tipo foram selecionados
            if (!cliente_id || !tecnico_id || !tipo_id) {
                showNotification('⚠️ Por favor, selecione cliente, técnico e tipo de serviço!', 'warning');
                return;
            }
            
            // Buscar objetos completos para uso local
            const clienteObj = clientes.find(c => c.id === cliente_id);
            const tecnicoObj = tecnicos.find(t => t.id === tecnico_id);
            const tipoObj = tipos.find(t => t.id === tipo_id);
            
            // Criar tarefa no formato local (com nomes para exibição)
            const novaTarefa = {
                id: crypto.randomUUID(),
                titulo,
                cliente: clienteObj ? clienteObj.nome : '', // Nome para exibição local
                tecnico: tecnicoObj ? tecnicoObj.nome : '', // Nome para exibição local
                tipo: tipoObj ? tipoObj.nome : '', // Nome para exibição local
                cliente_id, // ID para salvar no banco
                tecnico_id, // ID para salvar no banco
                tipo_id, // ID para salvar no banco
                data,
                prioridade,
                observacoes,
                status: 'pendente',
                progresso: 0,
                checklist: tipoObj && tipoObj.checklist ? tipoObj.checklist.map(item => ({ item, concluido: false })) : [],
                _isNew: true  // Marca para indicar que é uma nova tarefa
            };
            
            tarefas.push(novaTarefa);
            saveData();
            document.getElementById('tarefa-form').reset();
            renderTarefas();
            updateStats();
            showNotification('✅ Tarefa criada com sucesso!', 'success');
        }

        function renderTarefas() {
            const tbody = document.getElementById('tarefas-tbody');
            tbody.innerHTML = '';
            
            if (tarefas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: var(--gray-500);">Nenhuma tarefa cadastrada</td></tr>';
                return;
            }
            
            tarefas.forEach((tarefa, index) => {
                try {
                const row = document.createElement('tr');
                const statusClass = `status-${tarefa.status.replace(' ', '-')}`;
                // Verificar se checklist existe antes de acessar
                const checklist = tarefa.checklist || [];
                const progresso = checklist.length > 0 ? 
                    Math.round((checklist.filter(item => item.concluido).length / checklist.length) * 100) : 0;
                
                const prioridadeClass = `prioridade-${tarefa.prioridade}`;
                const prioridadeIcon = {
                    'baixa': '🟢',
                    'media': '🟡', 
                    'alta': '🟠',
                    'urgente': '🔴'
                };
                
                row.innerHTML = `
                    <td>
                        <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.25rem;">${tarefa.titulo}</div>
                        ${tarefa.observacoes ? `<div style="font-size: 0.8rem; color: var(--gray-500); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${tarefa.observacoes}">${tarefa.observacoes}</div>` : ''}
                    </td>
                    <td>${tarefa.cliente}</td>
                    <td>${tarefa.tecnico}</td>
                    <td>${tarefa.tipo}</td>
                    <td>${new Date(tarefa.data).toLocaleDateString('pt-BR')}</td>
                    <td>
                        <span class="${prioridadeClass}" style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.8rem; font-weight: 600;">
                            ${prioridadeIcon[tarefa.prioridade]} ${tarefa.prioridade}
                        </span>
                    </td>
                    <td><span class="task-status ${statusClass}">${tarefa.status}</span></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 60px; height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${progresso}%; height: 100%; background: ${progresso === 100 ? 'var(--success)' : progresso > 50 ? 'var(--warning)' : 'var(--info)'}; transition: width 0.3s ease;"></div>
                            </div>
                            <span style="font-size: 0.8rem; font-weight: 600; color: var(--gray-600);">${progresso}%</span>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                            <button onclick="updateTarefaStatus('${tarefa.id}', 'em-andamento')" 
                                    class="btn btn-info btn-sm" ${tarefa.status === 'em-andamento' ? 'disabled' : ''} 
                                    style="padding: 0.4rem 0.6rem; font-size: 0.8rem;" title="Iniciar">
                                <i class="fas fa-play" style="font-size: 1rem;"></i>
                            </button>
                            <button onclick="updateTarefaStatus('${tarefa.id}', 'concluida')" 
                                    class="btn btn-success btn-sm" ${tarefa.status === 'concluida' ? 'disabled' : ''}
                                    style="padding: 0.4rem 0.6rem; font-size: 0.8rem;" title="Concluir">
                                <i class="fas fa-check" style="font-size: 1rem;"></i>
                            </button>
                            <button onclick="imprimirTarefa('${tarefa.id}')" class="btn btn-warning btn-sm"
                                    style="padding: 0.4rem 0.6rem; font-size: 0.8rem;" title="Imprimir">
                                <i class="fas fa-print" style="font-size: 1rem;"></i>
                            </button>
                            <button onclick="abrirModoTecnico('${tarefa.id}')" class="btn btn-info btn-sm"
                                    style="padding: 0.4rem 0.6rem; font-size: 0.8rem;" title="Checklist & Modo Técnico">
                                <i class="fas fa-tools" style="font-size: 1rem;"></i>
                            </button>
                            <button onclick="deleteTarefa('${tarefa.id}')" class="btn btn-danger btn-sm"
                                    style="padding: 0.4rem 0.6rem; font-size: 0.8rem;" title="Excluir">
                                <i class="fas fa-trash" style="font-size: 1rem;"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
                
                } catch (error) {
                    console.error(`❌ Erro ao renderizar tarefa ${index + 1}:`, error.message);
                    // Adicionar linha de erro na tabela
                    const errorRow = document.createElement('tr');
                    errorRow.innerHTML = `
                        <td colspan="9" style="background: #fee; color: #c00; padding: 1rem; text-align: center;">
                            ⚠️ Erro ao renderizar tarefa: ${tarefa.titulo || 'Sem título'} - ${error.message}
                        </td>
                    `;
                    tbody.appendChild(errorRow);
                }
            });
        }

        function toggleChecklist(tarefaId) {
            const content = document.getElementById(`checklist-content-${tarefaId}`);
            const icon = document.getElementById(`checklist-icon-${tarefaId}`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.textContent = '+';
            } else {
                content.classList.add('expanded');
                icon.textContent = '-';
            }
        }

        function toggleChecklistItem(tarefaId, itemIndex) {
            console.log('Toggle checklist:', tarefaId, itemIndex);
            const tarefa = tarefas.find(t => t.id === tarefaId);
            console.log('Tarefa encontrada:', tarefa);
            if (tarefa && tarefa.checklist[itemIndex]) {
                tarefa.checklist[itemIndex].concluido = !tarefa.checklist[itemIndex].concluido;
                
                // Calcular progresso atualizado
                const progresso = Math.round((tarefa.checklist.filter(item => item.concluido).length / tarefa.checklist.length) * 100);
                
                // Atualizar status da tarefa baseado no progresso
                if (progresso === 100 && tarefa.status !== 'concluida') {
                    tarefa.status = 'concluida';
                } else if (progresso > 0 && tarefa.status === 'pendente') {
                    tarefa.status = 'em-andamento';
                } else if (progresso === 0 && tarefa.status === 'em-andamento') {
                    tarefa.status = 'pendente';
                }
                
                saveData();
                
                // Atualizar item específico no modal
                const item = document.querySelector(`input[onchange="toggleChecklistItem(${tarefaId}, ${itemIndex})"]`).parentElement;
                if (tarefa.checklist[itemIndex].concluido) {
                    item.classList.add('completed');
                } else {
                    item.classList.remove('completed');
                }
                
                // Atualizar apenas o status na tabela principal
                updateStatusInTable(tarefaId);
                
                // Atualizar estatísticas do dashboard
                updateStats();
            }
        }

        function updateStatusInTable(tarefaId) {
            // Simplesmente re-renderizar a tabela inteira para garantir sincronização
            renderTarefas();
            updateStats();
        }

        function updateTarefaStatus(tarefaId, novoStatus) {
            const tarefa = tarefas.find(t => t.id === tarefaId);
            if (tarefa) {
                tarefa.status = novoStatus;
                saveData();
                renderTarefas();
                showNotification(`✅ Tarefa ${novoStatus}!`, 'success');
            }
        }

        async function deleteTarefa(id) {
            const tarefa = tarefas.find(t => t.id === id);
            if (!tarefa) return;
            
            showConfirmModal(
                'Excluir Tarefa',
                `Tem certeza que deseja excluir a tarefa <strong>"${tarefa.titulo}"</strong>?<br><br>Esta ação não pode ser desfeita.`,
                async () => {
                    try {
                        // Deletar do Supabase
                        await fetch(`/api/deleteData?tabela=tarefas&id=${id}`, {
                            method: 'DELETE'
                        });
                        
                        // Remover da lista local
                        tarefas = tarefas.filter(t => t.id !== id);
                        renderTarefas();
                        showNotification('✅ Tarefa excluída com sucesso!', 'success');
                    } catch (error) {
                        console.error('Erro ao deletar tarefa:', error);
                        showNotification('❌ Erro ao excluir tarefa!', 'error');
                    }
                }
            );
        }

        // USUÁRIOS
        function handleUsuarioSubmit(e) {
            e.preventDefault();
            
            const nome = document.getElementById('usuario-nome').value;
            const usuario = document.getElementById('usuario-login').value;
            const senha = document.getElementById('usuario-senha').value;
            const perfil = document.getElementById('usuario-perfil').value;
            const ativo = document.getElementById('usuario-ativo').value === 'true';
            
            if (editingUsuarioId) {
                const index = usuarios.findIndex(u => u.id === editingUsuarioId);
                if (index !== -1) {
                    usuarios[index] = { ...usuarios[index], nome, usuario, senha, perfil, ativo };
                    showNotification('✅ Usuário atualizado com sucesso!', 'success');
                }
                editingUsuarioId = null;
            } else {
                const novoUsuario = {
                    id: crypto.randomUUID(),
                    nome, usuario, senha, perfil, ativo
                };
                usuarios.push(novoUsuario);
                showNotification('✅ Usuário adicionado com sucesso!', 'success');
            }
            
            saveData();
            document.getElementById('usuario-form').reset();
            renderUsuarios();
        }

        function renderUsuarios() {
            const tbody = document.querySelector('#usuarios-table tbody');
            tbody.innerHTML = '';
            
            usuarios.forEach(usuario => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${usuario.nome}</td>
                    <td>${usuario.usuario}</td>
                    <td>${usuario.perfil}</td>
                    <td><span class="status-${usuario.ativo ? 'ativo' : 'inativo'}">${usuario.ativo ? 'Ativo' : 'Inativo'}</span></td>
                    <td>
                        <button onclick="editUsuario(${usuario.id})" class="btn btn-info btn-sm">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button onclick="deleteUsuario(${usuario.id})" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editUsuario(id) {
            const usuario = usuarios.find(u => u.id === id);
            if (usuario) {
                editingUsuarioId = id;
                document.getElementById('usuario-nome').value = usuario.nome;
                document.getElementById('usuario-login').value = usuario.usuario;
                document.getElementById('usuario-senha').value = usuario.senha;
                document.getElementById('usuario-perfil').value = usuario.perfil;
                document.getElementById('usuario-ativo').value = usuario.ativo.toString();
                
                const btn = document.querySelector('#usuario-form button[type="submit"]');
                btn.innerHTML = '<i class="fas fa-save"></i> Atualizar Usuário';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-warning');
            }
        }

        function deleteUsuario(id) {
            const usuario = usuarios.find(u => u.id === id);
            if (!usuario) return;
            
            showConfirmModal(
                'Excluir Usuário',
                `Tem certeza que deseja excluir o usuário <strong>"${usuario.nome}"</strong>?<br><br>Esta ação não pode ser desfeita.`,
                () => {
                    usuarios = usuarios.filter(u => u.id !== id);
                    saveData();
                    renderUsuarios();
                    showNotification('✅ Usuário excluído com sucesso!', 'success');
                }
            );
        }

        // UTILITÁRIOS
        function updateSelects() {
            // Atualizar selects de tarefas
            const clienteSelect = document.getElementById('tarefa-cliente');
            const tecnicoSelect = document.getElementById('tarefa-tecnico');
            const tipoSelect = document.getElementById('tarefa-tipo');
            const filtroClienteSelect = document.getElementById('filtro-cliente');
            const filtroTecnicoSelect = document.getElementById('filtro-tecnico');
            
            // Clientes
            clienteSelect.innerHTML = '<option value="">Selecione o cliente</option>';
            filtroClienteSelect.innerHTML = '<option value="">Todos os clientes</option>';
            clientes.forEach(cliente => {
                // Usar ID como value para salvar no banco, nome como texto de exibição
                const option = `<option value="${cliente.id}">${cliente.nome}</option>`;
                clienteSelect.innerHTML += option;
                // Filtro usa nome para compatibilidade com sistema de busca
                filtroClienteSelect.innerHTML += `<option value="${cliente.nome}">${cliente.nome}</option>`;
            });
            
            // Técnicos
            tecnicoSelect.innerHTML = '<option value="">Selecione o técnico</option>';
            filtroTecnicoSelect.innerHTML = '<option value="">Todos os técnicos</option>';
            tecnicos.forEach(tecnico => {
                // Usar ID como value para salvar no banco, nome como texto de exibição
                const option = `<option value="${tecnico.id}">${tecnico.nome}</option>`;
                tecnicoSelect.innerHTML += option;
                // Filtro usa nome para compatibilidade com sistema de busca
                filtroTecnicoSelect.innerHTML += `<option value="${tecnico.nome}">${tecnico.nome}</option>`;
            });
            
            // Tipos
            tipoSelect.innerHTML = '<option value="">Selecione o tipo</option>';
            tipos.forEach(tipo => {
                // Usar ID como value para salvar no banco, nome como texto de exibição
                tipoSelect.innerHTML += `<option value="${tipo.id}">${tipo.nome}</option>`;
            });
        }

        function buscarTarefas() {
            const termo = document.getElementById('busca-tarefas').value.toLowerCase();
            if (termo.length < 2) {
                renderTarefas();
                return;
            }
            
            const tarefasFiltradas = tarefas.filter(tarefa => {
                return tarefa.titulo.toLowerCase().includes(termo) ||
                       tarefa.cliente.toLowerCase().includes(termo) ||
                       tarefa.tecnico.toLowerCase().includes(termo) ||
                       tarefa.tipo.toLowerCase().includes(termo) ||
                       (tarefa.observacoes && tarefa.observacoes.toLowerCase().includes(termo));
            });
            
            renderTarefasFiltradas(tarefasFiltradas);
        }

        function aplicarFiltros() {
            const filtroCliente = document.getElementById('filtro-cliente').value;
            const filtroTecnico = document.getElementById('filtro-tecnico').value;
            const filtroStatus = document.getElementById('filtro-status').value;
            const filtroPrioridade = document.getElementById('filtro-prioridade').value;
            const termoBusca = document.getElementById('busca-tarefas').value.toLowerCase();
            
            // Filtrar tarefas
            let tarefasFiltradas = tarefas.filter(tarefa => {
                const matchCliente = !filtroCliente || tarefa.cliente === filtroCliente;
                const matchTecnico = !filtroTecnico || tarefa.tecnico === filtroTecnico;
                const matchStatus = !filtroStatus || tarefa.status === filtroStatus;
                const matchPrioridade = !filtroPrioridade || tarefa.prioridade === filtroPrioridade;
                const matchBusca = !termoBusca || termoBusca.length < 2 || 
                    tarefa.titulo.toLowerCase().includes(termoBusca) ||
                    tarefa.cliente.toLowerCase().includes(termoBusca) ||
                    tarefa.tecnico.toLowerCase().includes(termoBusca) ||
                    tarefa.tipo.toLowerCase().includes(termoBusca) ||
                    (tarefa.observacoes && tarefa.observacoes.toLowerCase().includes(termoBusca));
                
                return matchCliente && matchTecnico && matchStatus && matchPrioridade && matchBusca;
            });
            
            // Renderizar tarefas filtradas
            renderTarefasFiltradas(tarefasFiltradas);
            showNotification(`🔍 ${tarefasFiltradas.length} tarefa(s) encontrada(s)!`, 'info');
        }

        function renderTarefasFiltradas(tarefasFiltradas) {
            const tbody = document.getElementById('tarefas-tbody');
            tbody.innerHTML = '';
            
            if (tarefasFiltradas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            <h3 style="margin: 0 0 0.5rem 0; color: var(--gray-600);">Nenhuma tarefa encontrada</h3>
                            <p style="margin: 0;">Tente ajustar os filtros para encontrar o que procura.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tarefasFiltradas.forEach(tarefa => {
                const row = document.createElement('tr');
                const statusClass = `status-${tarefa.status.replace(' ', '-')}`;
                const progresso = tarefa.checklist.length > 0 ? 
                    Math.round((tarefa.checklist.filter(item => item.concluido).length / tarefa.checklist.length) * 100) : 0;
                
                const prioridadeClass = `prioridade-${tarefa.prioridade}`;
                const prioridadeIcon = {
                    'baixa': '🟢',
                    'media': '🟡', 
                    'alta': '🟠',
                    'urgente': '🔴'
                };
                
                row.innerHTML = `
                    <td>
                        <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.25rem;">${tarefa.titulo}</div>
                        ${tarefa.observacoes ? `<div style="font-size: 0.8rem; color: var(--gray-500); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${tarefa.observacoes}">${tarefa.observacoes}</div>` : ''}
                    </td>
                    <td>${tarefa.cliente}</td>
                    <td>${tarefa.tecnico}</td>
                    <td>${tarefa.tipo}</td>
                    <td>${new Date(tarefa.data).toLocaleDateString('pt-BR')}</td>
                    <td>
                        <span class="${prioridadeClass}" style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.8rem; font-weight: 600;">
                            ${prioridadeIcon[tarefa.prioridade]} ${tarefa.prioridade}
                        </span>
                    </td>
                    <td><span class="task-status ${statusClass}">${tarefa.status}</span></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 60px; height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${progresso}%; height: 100%; background: ${progresso === 100 ? 'var(--success)' : progresso > 50 ? 'var(--warning)' : 'var(--info)'}; transition: width 0.3s ease;"></div>
                            </div>
                            <span style="font-size: 0.8rem; font-weight: 600; color: var(--gray-600);">${progresso}%</span>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                            <button onclick="updateTarefaStatus('${tarefa.id}', 'em-andamento')" 
                                    class="btn btn-info btn-sm" ${tarefa.status === 'em-andamento' ? 'disabled' : ''} 
                                    style="padding: 0.4rem 0.6rem; font-size: 0.8rem;" title="Iniciar">
                                <i class="fas fa-play" style="font-size: 1rem;"></i>
                            </button>
                            <button onclick="updateTarefaStatus('${tarefa.id}', 'concluida')" 
                                    class="btn btn-success btn-sm" ${tarefa.status === 'concluida' ? 'disabled' : ''}
                                    style="padding: 0.4rem 0.6rem; font-size: 0.8rem;" title="Concluir">
                                <i class="fas fa-check" style="font-size: 1rem;"></i>
                            </button>
                            <button onclick="imprimirTarefa('${tarefa.id}')" class="btn btn-warning btn-sm"
                                    style="padding: 0.4rem 0.6rem; font-size: 0.8rem;" title="Imprimir">
                                <i class="fas fa-print" style="font-size: 1rem;"></i>
                            </button>
                            <button onclick="abrirModoTecnico('${tarefa.id}')" class="btn btn-info btn-sm"
                                    style="padding: 0.4rem 0.6rem; font-size: 0.8rem;" title="Checklist & Modo Técnico">
                                <i class="fas fa-tools" style="font-size: 1rem;"></i>
                            </button>
                            <button onclick="deleteTarefa('${tarefa.id}')" class="btn btn-danger btn-sm"
                                    style="padding: 0.4rem 0.6rem; font-size: 0.8rem;" title="Excluir">
                                <i class="fas fa-trash" style="font-size: 1rem;"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function limparFiltros() {
            document.getElementById('busca-tarefas').value = '';
            document.getElementById('filtro-cliente').value = '';
            document.getElementById('filtro-tecnico').value = '';
            document.getElementById('filtro-status').value = '';
            document.getElementById('filtro-prioridade').value = '';
            renderTarefas();
            showNotification('🧹 Filtros limpos!', 'info');
        }





        function imprimirTarefa(tarefaId) {
            const tarefa = tarefas.find(t => t.id === tarefaId);
            if (!tarefa) return;
            
            // Buscar informações detalhadas do cliente
            const cliente = clientes.find(c => c.nome === tarefa.cliente);
            const tecnico = tecnicos.find(t => t.nome === tarefa.tecnico);
            
            console.log('Imprimindo tarefa:', tarefa);
            console.log('Cliente encontrado:', cliente);
            console.log('Técnico encontrado:', tecnico);
            
            // Analisar quantidade de informações para ajustar layout
            const temObservacoes = tarefa.observacoes && tarefa.observacoes.trim().length > 0;
            const temChecklist = tarefa.checklist && tarefa.checklist.length > 0;
            const temInfoCliente = cliente && (cliente.cnpj || cliente.whatsapp || cliente.endereco || cliente.bairro || cliente.cidade || cliente.cep);
            const temInfoTecnico = tecnico && (tecnico.especialidade || tecnico.telefone || tecnico.email);
            
            console.log('Análise de conteúdo:', {
                temObservacoes,
                temChecklist,
                temInfoCliente,
                temInfoTecnico,
                qtdChecklist: tarefa.checklist ? tarefa.checklist.length : 0
            });
            
            // Função para gerar informações do cliente de forma dinâmica
            function gerarInfoCliente(cliente) {
                if (!cliente) return '<p style="margin: 6px 0; color: #6b7280; font-size: 13px; font-style: italic;">Informações não disponíveis</p>';
                
                const infoCliente = [];
                if (cliente.cnpj) infoCliente.push(`<p style="margin: 6px 0; color: #6b7280; font-size: 13px;"><strong>CNPJ:</strong> ${cliente.cnpj}</p>`);
                if (cliente.whatsapp) infoCliente.push(`<p style="margin: 6px 0; color: #6b7280; font-size: 13px;"><strong>WhatsApp:</strong> ${cliente.whatsapp}</p>`);
                if (cliente.endereco) infoCliente.push(`<p style="margin: 6px 0; color: #6b7280; font-size: 13px;"><strong>Endereço:</strong> ${cliente.endereco}</p>`);
                if (cliente.bairro) infoCliente.push(`<p style="margin: 6px 0; color: #6b7280; font-size: 13px;"><strong>Bairro:</strong> ${cliente.bairro}</p>`);
                if (cliente.cidade) infoCliente.push(`<p style="margin: 6px 0; color: #6b7280; font-size: 13px;"><strong>Cidade:</strong> ${cliente.cidade}</p>`);
                if (cliente.cep) infoCliente.push(`<p style="margin: 6px 0; color: #6b7280; font-size: 13px;"><strong>CEP:</strong> ${cliente.cep}</p>`);
                
                return infoCliente.length > 0 ? infoCliente.join('') : '<p style="margin: 6px 0; color: #6b7280; font-size: 13px; font-style: italic;">Informações básicas não disponíveis</p>';
            }
            
            // Função para gerar informações do técnico de forma dinâmica
            function gerarInfoTecnico(tecnico) {
                if (!tecnico) return '<p style="margin: 6px 0; color: #6b7280; font-size: 13px; font-style: italic;">Informações não disponíveis</p>';
                
                const infoTecnico = [];
                if (tecnico.especialidade) infoTecnico.push(`<p style="margin: 6px 0; color: #6b7280; font-size: 13px;"><strong>Especialidade:</strong> ${tecnico.especialidade}</p>`);
                if (tecnico.telefone) infoTecnico.push(`<p style="margin: 6px 0; color: #6b7280; font-size: 13px;"><strong>Telefone:</strong> ${tecnico.telefone}</p>`);
                if (tecnico.email) infoTecnico.push(`<p style="margin: 6px 0; color: #6b7280; font-size: 13px;"><strong>E-mail:</strong> ${tecnico.email}</p>`);
                
                return infoTecnico.length > 0 ? infoTecnico.join('') : '<p style="margin: 6px 0; color: #6b7280; font-size: 13px; font-style: italic;">Informações básicas não disponíveis</p>';
            }
            
            // Determinar layout baseado na quantidade de informações
            const layoutCliente = temInfoCliente ? '1fr 1fr' : '1fr';
            const mostrarSecaoTecnico = temInfoTecnico;
            const mostrarSecaoObservacoes = temObservacoes;
            
            // PÁGINA 1 - CABEÇALHO E INFORMAÇÕES ADAPTÁVEIS
            let conteudo = `
                <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 15px; background: white; page-break-inside: avoid;">
                    <!-- CABEÇALHO ADAPTÁVEL -->
                    <div style="text-align: center; margin-bottom: ${temObservacoes || temChecklist ? '20px' : '15px'}; border-bottom: 2px solid #1e40af; padding-bottom: 15px;">
                        <h1 style="color: #1e40af; margin: 0; font-size: 24px; font-weight: bold;">TECNO-CHECKLIST</h1>
                        <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">Relatório de Execução de Serviços</p>
                        <div style="margin-top: 10px; padding: 8px; background: #f0f9ff; border-radius: 6px; display: inline-block;">
                            <span style="color: #1e40af; font-weight: bold; font-size: 16px;">${tarefa.titulo}</span>
                        </div>
                    </div>
                    
                    <!-- INFORMAÇÕES ADAPTÁVEIS -->
                    <div style="display: grid; grid-template-columns: ${layoutCliente}; gap: 15px; margin-bottom: 20px;">
                        <!-- INFORMAÇÕES DA TAREFA -->
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h3 style="color: #1e40af; margin: 0 0 12px 0; font-size: 16px; font-weight: bold;">Informações da Tarefa</h3>
                            <p style="margin: 6px 0; color: #374151; font-size: 14px;"><strong>Tarefa:</strong> ${tarefa.titulo}</p>
                            <p style="margin: 6px 0; color: #374151; font-size: 14px;"><strong>Data:</strong> ${new Date(tarefa.data).toLocaleDateString('pt-BR')}</p>
                            <p style="margin: 6px 0; color: #374151; font-size: 14px;"><strong>Status:</strong> 
                                <span style="padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; 
                                    background: ${tarefa.status === 'concluida' ? '#d1fae5' : tarefa.status === 'em-andamento' ? '#fef3c7' : '#f3f4f6'}; 
                                    color: ${tarefa.status === 'concluida' ? '#065f46' : tarefa.status === 'em-andamento' ? '#92400e' : '#374151'};">
                                    ${tarefa.status.toUpperCase()}
                                </span>
                            </p>
                            <p style="margin: 6px 0; color: #374151; font-size: 14px;"><strong>Prioridade:</strong> 
                                <span style="padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;
                                    background: ${tarefa.prioridade === 'alta' ? '#fee2e2' : tarefa.prioridade === 'media' ? '#fef3c7' : '#f0f9ff'};
                                    color: ${tarefa.prioridade === 'alta' ? '#991b1b' : tarefa.prioridade === 'media' ? '#92400e' : '#1e40af'};">
                                    ${tarefa.prioridade.toUpperCase()}
                                </span>
                            </p>
                            <p style="margin: 6px 0; color: #374151; font-size: 14px;"><strong>Tipo:</strong> ${tarefa.tipo}</p>
                            <p style="margin: 6px 0; color: #374151; font-size: 14px;"><strong>ID:</strong> #${tarefa.id}</p>
                        </div>
                        
                        <!-- INFORMAÇÕES DO CLIENTE (apenas se houver informações) -->
                        ${temInfoCliente ? `
                            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border: 1px solid #bae6fd;">
                                <h3 style="color: #1e40af; margin: 0 0 12px 0; font-size: 16px; font-weight: bold;">Informações do Cliente</h3>
                                <p style="margin: 6px 0; color: #374151; font-size: 14px; font-weight: 600;">${tarefa.cliente}</p>
                                ${gerarInfoCliente(cliente)}
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- INFORMAÇÕES DO TÉCNICO (apenas se houver informações) -->
                    ${mostrarSecaoTecnico ? `
                        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #bbf7d0;">
                            <h3 style="color: #059669; margin: 0 0 12px 0; font-size: 16px; font-weight: bold;">Técnico Responsável</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <p style="margin: 6px 0; color: #374151; font-size: 14px; font-weight: 600;">${tarefa.tecnico}</p>
                                    ${tecnico?.especialidade ? `<p style="margin: 6px 0; color: #6b7280; font-size: 13px;"><strong>Especialidade:</strong> ${tecnico.especialidade}</p>` : ''}
                                </div>
                                <div>
                                    ${tecnico?.telefone ? `<p style="margin: 6px 0; color: #6b7280; font-size: 13px;"><strong>Telefone:</strong> ${tecnico.telefone}</p>` : ''}
                                    ${tecnico?.email ? `<p style="margin: 6px 0; color: #6b7280; font-size: 13px;"><strong>E-mail:</strong> ${tecnico.email}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- OBSERVAÇÕES (apenas se houver) -->
                    ${mostrarSecaoObservacoes ? `
                        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #fbbf24;">
                            <h3 style="color: #92400e; margin: 0 0 10px 0; font-size: 16px; font-weight: bold;">Observações do Serviço</h3>
                            <p style="margin: 0; color: #374151; line-height: 1.4; font-size: 14px; white-space: pre-wrap;">${tarefa.observacoes}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // PÁGINA 2 - CHECKLIST DE EXECUÇÃO ADAPTÁVEL (se houver)
            if (temChecklist) {
                const progresso = Math.round((tarefa.checklist.filter(item => item.concluido).length / tarefa.checklist.length) * 100);
                
                // Ajustar itens por página baseado na quantidade total
                let itensPorPagina;
                if (tarefa.checklist.length <= 10) {
                    itensPorPagina = tarefa.checklist.length; // Uma página só
                } else if (tarefa.checklist.length <= 20) {
                    itensPorPagina = 15; // Página única ou duas páginas
                } else if (tarefa.checklist.length <= 50) {
                    itensPorPagina = 18; // Múltiplas páginas compactas
                } else {
                    itensPorPagina = 20; // Muitos itens, página mais densa
                }
                
                const totalPaginas = Math.ceil(tarefa.checklist.length / itensPorPagina);
                
                console.log(`Checklist adaptado: ${tarefa.checklist.length} itens, ${itensPorPagina} por página, ${totalPaginas} páginas`);
                
                for (let pagina = 0; pagina < totalPaginas; pagina++) {
                    const inicio = pagina * itensPorPagina;
                    const fim = Math.min(inicio + itensPorPagina, tarefa.checklist.length);
                    const itensPagina = tarefa.checklist.slice(inicio, fim);
                    
                    conteudo += `
                        <div style="page-break-before: ${pagina > 0 ? 'always' : 'always'}; font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 15px; background: white;">
                            <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #1e40af; padding-bottom: 12px;">
                                <h2 style="color: #1e40af; margin: 0; font-size: 20px; font-weight: bold;">Checklist de Execução</h2>
                                ${pagina === 0 ? `
                                    <div style="background: #f3f4f6; padding: 12px; border-radius: 6px; margin: 12px 0; text-align: center;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <span style="color: #374151; font-weight: 600; font-size: 14px;">Progresso de Execução</span>
                                            <span style="color: #1e40af; font-weight: bold; font-size: 16px;">${progresso}%</span>
                                        </div>
                                        <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                            <div style="width: ${progresso}%; height: 100%; background: ${progresso === 100 ? '#10b981' : progresso > 50 ? '#f59e0b' : '#3b82f6'};"></div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div>
                                ${itensPagina.map((item, index) => `
                                    <div style="margin: 8px 0; padding: 12px; background: white; border-radius: 6px; border-left: 4px solid ${item.concluido ? '#10b981' : '#f59e0b'}; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 20px; height: 20px; border-radius: 50%; background: ${item.concluido ? '#10b981' : '#f59e0b'}; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                                <span style="color: white; font-size: 12px; font-weight: bold;">${item.concluido ? '✓' : '○'}</span>
                                            </div>
                                            <div style="flex: 1;">
                                                <p style="margin: 0; color: ${item.concluido ? '#6b7280' : '#374151'}; ${item.concluido ? 'text-decoration: line-through;' : ''} font-size: 14px; line-height: 1.4; font-weight: 500;">
                                                    ${item.item}
                                                </p>
                                                ${item.observacoes ? `
                                                    <p style="margin: 6px 0 0 0; color: #6b7280; font-size: 12px; font-style: italic; background: #f9fafb; padding: 6px; border-radius: 4px;">
                                                        <strong>Obs:</strong> ${item.observacoes}
                                                    </p>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            ${pagina < totalPaginas - 1 ? `
                                <div style="text-align: center; margin-top: 20px; color: #9ca3af; font-size: 11px; font-style: italic;">
                                    Continua na próxima página...
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            }
            
            // PÁGINA FINAL - ASSINATURAS ADAPTÁVEIS
            // Só adicionar página de assinaturas se houver conteúdo suficiente ou se for uma tarefa importante
            const adicionarAssinaturas = temChecklist || temObservacoes || tarefa.prioridade === 'alta' || tarefa.status === 'concluida';
            
            if (adicionarAssinaturas) {
                conteudo += `
                    <div style="page-break-before: always; font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 15px; background: white;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h2 style="color: #1e40af; margin: 0; font-size: 20px; font-weight: bold;">Assinaturas</h2>
                            <p style="color: #6b7280; margin: 8px 0 0 0; font-size: 14px;">Confirmação de Execução do Serviço</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 25px;">
                            <!-- ASSINATURA DO TÉCNICO -->
                            <div style="text-align: center; border: 2px solid #e5e7eb; border-radius: 8px; padding: 20px; background: #f9fafb;">
                                <h3 style="color: #1e40af; margin: 0 0 15px 0; font-size: 16px; font-weight: bold;">Técnico Responsável</h3>
                                <div style="border: 2px dashed #d1d5db; height: 60px; margin-bottom: 12px; border-radius: 6px; display: flex; align-items: center; justify-content: center; background: white;">
                                    <span style="color: #9ca3af; font-size: 12px; font-weight: 500;">Assinatura do Técnico</span>
                                </div>
                                <p style="margin: 0 0 4px 0; color: #374151; font-weight: 600; font-size: 14px;">${tarefa.tecnico}</p>
                                <p style="margin: 0 0 12px 0; color: #6b7280; font-size: 12px;">Técnico Responsável</p>
                                <div style="margin: 12px auto; border-bottom: 2px solid #d1d5db; width: 120px;"></div>
                                <p style="margin: 6px 0 0 0; color: #6b7280; font-size: 11px;">Data: _______________</p>
                            </div>
                            
                            <!-- ASSINATURA DO CLIENTE -->
                            <div style="text-align: center; border: 2px solid #e5e7eb; border-radius: 8px; padding: 20px; background: #f9fafb;">
                                <h3 style="color: #1e40af; margin: 0 0 15px 0; font-size: 16px; font-weight: bold;">Cliente</h3>
                                <div style="border: 2px dashed #d1d5db; height: 60px; margin-bottom: 12px; border-radius: 6px; display: flex; align-items: center; justify-content: center; background: white;">
                                    <span style="color: #9ca3af; font-size: 12px; font-weight: 500;">Assinatura do Cliente</span>
                                </div>
                                <p style="margin: 0 0 4px 0; color: #374151; font-weight: 600; font-size: 14px;">${tarefa.cliente}</p>
                                <p style="margin: 0 0 12px 0; color: #6b7280; font-size: 12px;">Cliente</p>
                                <div style="margin: 12px auto; border-bottom: 2px solid #d1d5db; width: 120px;"></div>
                                <p style="margin: 6px 0 0 0; color: #6b7280; font-size: 11px;">Data: _______________</p>
                            </div>
                        </div>
                        
                        <!-- RODAPÉ ADAPTÁVEL -->
                        <div style="margin-top: 30px; text-align: center; color: #6b7280; font-size: 11px; border-top: 1px solid #e5e7eb; padding-top: 15px;">
                            <p style="margin: 3px 0; font-weight: 600;">Relatório gerado em ${new Date().toLocaleString('pt-BR')}</p>
                            <p style="margin: 3px 0; color: #9ca3af;">Tecno-Checklist - Sistema de Gestão de Serviços Técnicos</p>
                            ${temChecklist ? `<p style="margin: 3px 0; color: #9ca3af;">Checklist: ${tarefa.checklist.length} itens | Progresso: ${Math.round((tarefa.checklist.filter(item => item.concluido).length / tarefa.checklist.length) * 100)}%</p>` : ''}
                        </div>
                    </div>
                `;
            } else {
                // Rodapé simples se não houver assinaturas
                conteudo += `
                    <div style="margin-top: 30px; text-align: center; color: #6b7280; font-size: 11px; border-top: 1px solid #e5e7eb; padding-top: 15px;">
                        <p style="margin: 3px 0; font-weight: 600;">Relatório gerado em ${new Date().toLocaleString('pt-BR')}</p>
                        <p style="margin: 3px 0; color: #9ca3af;">Tecno-Checklist - Sistema de Gestão de Serviços Técnicos</p>
                    </div>
                `;
            }
            
            // Abrir janela de impressão
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>${tarefa.titulo} - Tecno-Checklist</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 0; 
                                padding: 20px; 
                                background: white;
                            }
                            @media print { 
                                body { margin: 0; padding: 15px; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>${conteudo}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            showNotification('🖨️ Preparando para impressão...', 'info');
        }

        function verChecklist(tarefaId) {
            // Função unificada que combina verChecklist e abrirModoTecnico
            abrirModoTecnico(tarefaId);
        }

        function abrirModoTecnico(tarefaId) {
            const tarefa = tarefas.find(t => t.id === tarefaId);
            if (!tarefa) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 10px;
                -webkit-overflow-scrolling: touch;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 15px;
                    width: 100%;
                    max-width: 500px;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                    -webkit-overflow-scrolling: touch;
                    touch-action: pan-y;
                ">
                    <!-- Header -->
                    <div style="
                        background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
                        color: white;
                        padding: 20px;
                        border-radius: 15px 15px 0 0;
                        text-align: center;
                    ">
                        <h2 style="margin: 0 0 10px 0; font-size: 20px;">🔧 Checklist & Modo Técnico</h2>
                        <p style="margin: 0; font-size: 14px; opacity: 0.9;">${tarefa.titulo}</p>
                        <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.8;">Cliente: ${tarefa.cliente}</p>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div style="padding: 20px 20px 10px 20px;">
                        <div style="
                            background: #f3f4f6;
                            height: 12px;
                            border-radius: 6px;
                            overflow: hidden;
                            margin-bottom: 10px;
                            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
                        ">
                            <div id="progress-bar" style="
                                height: 100%;
                                background: linear-gradient(90deg, #ef4444 0%, #f87171 100%);
                                width: ${Math.round((tarefa.checklist.filter(item => item.concluido).length / tarefa.checklist.length) * 100)}%;
                                transition: all 0.5s ease;
                                border-radius: 6px;
                            "></div>
                        </div>
                        <div style="text-align: center; font-size: 14px; color: #6b7280; font-weight: 600;">
                            <span id="progress-text">${tarefa.checklist.filter(item => item.concluido).length} de ${tarefa.checklist.length} concluídos (${Math.round((tarefa.checklist.filter(item => item.concluido).length / tarefa.checklist.length) * 100)}%)</span>
                        </div>
                    </div>
                    
                    <!-- Dica de Uso -->
                    <div style="
                        margin: 0 20px 15px 20px;
                        padding: 12px 16px;
                        background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
                        border-left: 4px solid #3b82f6;
                        border-radius: 8px;
                        font-size: 13px;
                        color: #1e40af;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    ">
                        <span style="font-size: 20px;">💡</span>
                        <span>Toque nos itens abaixo para marcar como concluído</span>
                    </div>
                    
                    <!-- Checklist Items -->
                    <div style="padding: 0 20px 20px 20px;">
                        ${tarefa.checklist.map((item, index) => `
                            <div id="checklist-item-${tarefaId}-${index}" 
                                 class="checklist-item-mobile ${item.concluido ? 'completed' : ''}" 
                                 data-tarefa-id="${tarefaId}"
                                 data-item-index="${index}"
                                 style="
                                    display: flex;
                                    align-items: center;
                                    padding: 20px;
                                    margin-bottom: 15px;
                                    background: ${item.concluido ? '#f0fdf4' : '#ffffff'};
                                    border: 2px solid ${item.concluido ? '#10b981' : '#e5e7eb'};
                                    border-radius: 12px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    user-select: none;
                                    box-shadow: ${item.concluido ? '0 4px 12px rgba(16, 185, 129, 0.2)' : '0 2px 8px rgba(0,0,0,0.1)'};
                                    -webkit-tap-highlight-color: rgba(16, 185, 129, 0.2);
                                    touch-action: manipulation;
                                 ">
                                <div id="checkbox-${tarefaId}-${index}" style="
                                    width: 32px;
                                    height: 32px;
                                    border: 3px solid ${item.concluido ? '#10b981' : '#d1d5db'};
                                    border-radius: 50%;
                                    margin-right: 20px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    background: ${item.concluido ? '#10b981' : 'white'};
                                    flex-shrink: 0;
                                    transition: all 0.3s ease;
                                    box-shadow: ${item.concluido ? '0 2px 8px rgba(16, 185, 129, 0.3)' : '0 1px 3px rgba(0,0,0,0.1)'};
                                ">
                                    ${item.concluido ? '<span style="color: white; font-weight: bold; font-size: 18px;">✓</span>' : ''}
                                </div>
                                <span id="text-${tarefaId}-${index}" style="
                                    color: ${item.concluido ? '#059669' : '#374151'};
                                    font-size: 18px;
                                    line-height: 1.5;
                                    font-weight: ${item.concluido ? '600' : '500'};
                                    ${item.concluido ? 'text-decoration: line-through; opacity: 0.8;' : ''}
                                    flex: 1;
                                ">${item.item}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Observações -->
                    <div style="padding: 0 20px 20px 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #374151;">
                            📝 Observações do Serviço:
                        </label>
                        <textarea id="observacoes-tecnico" 
                                  placeholder="Digite suas observações sobre o serviço realizado..."
                                  style="
                                    width: 100%;
                                    min-height: 80px;
                                    padding: 12px;
                                    border: 2px solid #e5e7eb;
                                    border-radius: 8px;
                                    font-size: 14px;
                                    resize: vertical;
                                    font-family: inherit;
                                  "></textarea>
                    </div>

                    <!-- Seção de Comentários e Anexos -->
                    <div class="comments-section" style="padding: 0 20px 20px 20px;">
                        <div class="comments-header">
                            <h3 class="comments-title">💬 Comentários e Anexos</h3>
                        </div>
                        
                        <!-- Formulário de Comentário -->
                        <div class="comment-form">
                            <textarea id="comment-input" 
                                      class="comment-input" 
                                      placeholder="Adicione um comentário sobre esta tarefa..."></textarea>
                            <div class="comment-actions">
                                <div class="file-upload">
                                    <input type="file" id="file-upload" multiple accept="image/*,.pdf,.doc,.docx,.txt">
                                    <label for="file-upload" class="file-upload-label">
                                        <i class="fas fa-paperclip"></i> Anexar Arquivo
                                    </label>
                                </div>
                                <button onclick="addComment(${tarefaId})" class="btn btn-primary btn-sm">
                                    <i class="fas fa-comment"></i> Comentar
                                </button>
                            </div>
                        </div>

                        <!-- Lista de Comentários -->
                        <div class="comments-list" id="comments-list-${tarefaId}">
                            <!-- Comentários serão carregados aqui -->
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="
                        padding: 20px;
                        border-top: 1px solid #e5e7eb;
                        display: flex;
                        gap: 10px;
                    ">
                        <button onclick="this.closest('.modal').remove()" 
                                style="
                                    flex: 1;
                                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                    color: white;
                                    border: none;
                                    padding: 16px 20px;
                                    border-radius: 12px;
                                    font-size: 16px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                                    transition: all 0.3s ease;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 8px;
                                ">
                            ✅ Salvar e Fechar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Adicionar event listeners para os itens do checklist
            const checklistItems = modal.querySelectorAll('.checklist-item-mobile');
            
            checklistItems.forEach((item) => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const tarefaId = this.getAttribute('data-tarefa-id');
                    const itemIndex = parseInt(this.getAttribute('data-item-index'));
                    toggleChecklistItemMobile(tarefaId, itemIndex);
                });
                
                // Adicionar cursor pointer para indicar que é clicável
                item.style.cursor = 'pointer';
            });
            
            // Inicializar sistema de comentários
            initCommentsSystem(tarefaId);
            
            // Inicializar cor da barra de progresso
            setTimeout(() => {
                const progressBar = document.getElementById('progress-bar');
                if (progressBar) {
                    const concluidos = tarefa.checklist.filter(item => item.concluido).length;
                    const total = tarefa.checklist.length;
                    const percentual = total > 0 ? Math.round((concluidos / total) * 100) : 0;
                    
                    if (percentual === 100) {
                        progressBar.style.background = 'linear-gradient(90deg, #10b981 0%, #059669 100%)';
                    } else if (percentual >= 75) {
                        progressBar.style.background = 'linear-gradient(90deg, #10b981 0%, #34d399 100%)';
                    } else if (percentual >= 50) {
                        progressBar.style.background = 'linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%)';
                    } else if (percentual >= 25) {
                        progressBar.style.background = 'linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%)';
                    } else {
                        progressBar.style.background = 'linear-gradient(90deg, #ef4444 0%, #f87171 100%)';
                    }
                }
            }, 100);
            
            // Adicionar CSS simples
            const style = document.createElement('style');
            style.textContent = `
                .checklist-item-mobile:hover {
                    transform: translateY(-1px);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                }
                .checklist-item-mobile:active {
                    transform: scale(0.98);
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .checklist-item-mobile {
                    transition: all 0.2s ease;
                }
                /* Melhor feedback visual para mobile */
                @media (max-width: 768px) {
                    .checklist-item-mobile:active {
                        background: rgba(16, 185, 129, 0.1) !important;
                    }
                }
            `;
            document.head.appendChild(style);
        }

        function toggleChecklistItemMobile(tarefaId, itemIndex) {
            const tarefa = tarefas.find(t => t.id === tarefaId);
            
            if (!tarefa || !tarefa.checklist || !tarefa.checklist[itemIndex]) {
                console.error('❌ Erro: Tarefa ou item do checklist não encontrado');
                return;
            }
            
            // Toggle do item
            tarefa.checklist[itemIndex].concluido = !tarefa.checklist[itemIndex].concluido;
            
            // Calcular progresso
            const concluidos = tarefa.checklist.filter(item => item.concluido).length;
            const total = tarefa.checklist.length;
            const percentual = total > 0 ? Math.round((concluidos / total) * 100) : 0;
            
            // Atualizar barra de progresso
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            if (progressBar) {
                progressBar.style.width = `${percentual}%`;
                // Mudar cor da barra baseada no progresso
                if (percentual === 100) {
                    progressBar.style.background = 'linear-gradient(90deg, #10b981 0%, #059669 100%)';
                } else if (percentual >= 75) {
                    progressBar.style.background = 'linear-gradient(90deg, #10b981 0%, #34d399 100%)';
                } else if (percentual >= 50) {
                    progressBar.style.background = 'linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%)';
                } else if (percentual >= 25) {
                    progressBar.style.background = 'linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%)';
                } else {
                    progressBar.style.background = 'linear-gradient(90deg, #ef4444 0%, #f87171 100%)';
                }
            }
            
            // Atualizar texto de progresso
            const progressoTexto = `${concluidos} de ${total} concluídos (${percentual}%)`;
            if (progressText) {
                progressText.textContent = progressoTexto;
            }
            
            // Atualizar status da tarefa
            if (percentual === 100) {
                tarefa.status = 'concluida';
            } else if (percentual > 0) {
                tarefa.status = 'em-andamento';
            } else {
                tarefa.status = 'pendente';
            }
            
            // Feedback háptico para mobile
            if ('vibrate' in navigator) {
                navigator.vibrate(10); // Vibração curta de 10ms
            }
            
            // Indicador visual de salvamento (breve)
            if (progressText) {
                progressText.textContent = '💾 ' + progressoTexto;
                progressText.style.color = '#f59e0b';
                
                setTimeout(() => {
                    progressText.textContent = progressoTexto;
                    progressText.style.color = '#6b7280';
                }, 800);
            }
            
            // Salvar dados
            saveData();
            updateStats();
            
            // Atualizar visual do item usando IDs únicos
            const itemElement = document.getElementById(`checklist-item-${tarefaId}-${itemIndex}`);
            const checkbox = document.getElementById(`checkbox-${tarefaId}-${itemIndex}`);
            const text = document.getElementById(`text-${tarefaId}-${itemIndex}`);
            
            if (itemElement && checkbox && text) {
                const isCompleted = tarefa.checklist[itemIndex].concluido;
                
                // Animação simples
                itemElement.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    itemElement.style.transform = 'scale(1)';
                }, 100);
                
                if (isCompleted) {
                    // Item concluído
                    itemElement.style.background = '#f0fdf4';
                    itemElement.style.borderColor = '#10b981';
                    itemElement.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.2)';
                    
                    checkbox.style.borderColor = '#10b981';
                    checkbox.style.background = '#10b981';
                    checkbox.innerHTML = '<span style="color: white; font-weight: bold; font-size: 18px;">✓</span>';
                    
                    text.style.color = '#059669';
                    text.style.textDecoration = 'line-through';
                    text.style.opacity = '0.8';
                    text.style.fontWeight = '600';
                    
                    itemElement.classList.add('completed');
                } else {
                    // Item desmarcado
                    itemElement.style.background = '#ffffff';
                    itemElement.style.borderColor = '#e5e7eb';
                    itemElement.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                    
                    checkbox.style.borderColor = '#d1d5db';
                    checkbox.style.background = 'white';
                    checkbox.innerHTML = '';
                    
                    text.style.color = '#374151';
                    text.style.textDecoration = 'none';
                    text.style.opacity = '1';
                    text.style.fontWeight = '500';
                    
                    itemElement.classList.remove('completed');
                }
            }
            
            // Atualizar título da tarefa
            const modalTitle = document.querySelector('.modal h2');
            if (modalTitle && percentual === 100) {
                modalTitle.innerHTML = '🔧 Checklist & Modo Técnico - ✅ Concluído';
                
                // Animação de confete ao completar 100%
                if ('vibrate' in navigator) {
                    navigator.vibrate([50, 30, 50]); // Padrão de vibração celebratória
                }
                
                // Mostrar notificação de conclusão
                showNotification('🎉 Parabéns! Tarefa 100% concluída!', 'success');
            } else if (modalTitle && percentual > 0) {
                modalTitle.innerHTML = '🔧 Checklist & Modo Técnico - ⚡ Em Andamento';
            } else if (modalTitle) {
                modalTitle.innerHTML = '🔧 Checklist & Modo Técnico';
            }
            
            // IMPORTANTE: Atualizar a tabela principal para refletir o progresso
            updateStatusInTable(tarefaId);
        }

        function gerarPDFSimples(tarefa) {
            const progresso = Math.round((tarefa.checklist.filter(item => item.concluido).length / tarefa.checklist.length) * 100);
            const concluidos = tarefa.checklist.filter(item => item.concluido);
            const pendentes = tarefa.checklist.filter(item => !item.concluido);
            
            let html = `
                <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: white;">
                    <div style="text-align: center; border-bottom: 3px solid #1e40af; padding-bottom: 20px; margin-bottom: 30px;">
                        <h1 style="color: #1e40af; margin: 0; font-size: 28px;">🔧 RELATÓRIO DE SERVIÇO TÉCNICO</h1>
                        <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 16px;">Sistema Tecno-Checklist</p>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                        <h2 style="color: #1f2937; margin: 0 0 15px 0; font-size: 20px;">📋 Informações da Tarefa</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <strong style="color: #374151;">Título:</strong><br>
                                <span style="color: #6b7280;">${tarefa.titulo}</span>
                            </div>
                            <div>
                                <strong style="color: #374151;">Cliente:</strong><br>
                                <span style="color: #6b7280;">${tarefa.cliente}</span>
                            </div>
                            <div>
                                <strong style="color: #374151;">Técnico:</strong><br>
                                <span style="color: #6b7280;">${tarefa.tecnico}</span>
                            </div>
                            <div>
                                <strong style="color: #374151;">Data:</strong><br>
                                <span style="color: #6b7280;">${new Date(tarefa.data).toLocaleDateString('pt-BR')}</span>
                            </div>
                            <div>
                                <strong style="color: #374151;">Prioridade:</strong><br>
                                <span style="color: #6b7280;">${tarefa.prioridade}</span>
                            </div>
                            <div>
                                <strong style="color: #374151;">Status:</strong><br>
                                <span style="color: #6b7280;">${tarefa.status}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #3b82f6;">
                        <h2 style="color: #1f2937; margin: 0 0 15px 0; font-size: 20px;">📊 Progresso do Serviço</h2>
                        <div style="background: #e5e7eb; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 10px;">
                            <div style="background: linear-gradient(90deg, #10b981, #3b82f6); height: 100%; width: ${progresso}%; transition: width 0.3s ease;"></div>
                        </div>
                        <p style="margin: 0; color: #374151; font-size: 16px; font-weight: 600;">
                            ${progresso}% concluído (${concluidos.length}/${tarefa.checklist.length} itens)
                        </p>
                    </div>
            `;
            
            if (concluidos.length > 0) {
                html += `
                    <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #10b981;">
                        <h2 style="color: #1f2937; margin: 0 0 15px 0; font-size: 20px;">✅ Itens Realizados</h2>
                        <ul style="margin: 0; padding-left: 20px;">
                `;
                concluidos.forEach((item, index) => {
                    html += `<li style="margin-bottom: 8px; color: #374151;">${item.item}</li>`;
                });
                html += `</ul></div>`;
            }
            
            if (pendentes.length > 0) {
                html += `
                    <div style="background: #fef3c7; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #f59e0b;">
                        <h2 style="color: #1f2937; margin: 0 0 15px 0; font-size: 20px;">⏳ Itens Pendentes</h2>
                        <ul style="margin: 0; padding-left: 20px;">
                `;
                pendentes.forEach((item, index) => {
                    html += `<li style="margin-bottom: 8px; color: #374151;">${item.item}</li>`;
                });
                html += `</ul></div>`;
            }
            
            html += `
                    <div style="background: #f8fafc; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                        <h2 style="color: #1f2937; margin: 0 0 15px 0; font-size: 20px;">📝 Observações</h2>
                        <p style="margin: 0; color: #6b7280; font-style: italic;">
                            ${tarefa.observacoes || 'Nenhuma observação registrada.'}
                        </p>
                    </div>
                    
                    <div style="text-align: center; border-top: 2px solid #e5e7eb; padding-top: 20px; margin-top: 30px;">
                        <p style="color: #6b7280; margin: 0; font-size: 14px;">
                            Relatório gerado em ${new Date().toLocaleString('pt-BR')} via Tecno-Checklist
                        </p>
                        <p style="color: #9ca3af; margin: 5px 0 0 0; font-size: 12px;">
                            Sistema de Gestão de Serviços Técnicos
                        </p>
                    </div>
                </div>
            `;
            
            return html;
        }

        async function enviarChecklistWhatsApp(tarefaId) {
            const tarefa = tarefas.find(t => t.id === tarefaId);
            if (!tarefa) {
                showNotification('❌ Tarefa não encontrada!', 'error');
                return;
            }
            
            const observacoesElement = document.getElementById('observacoes-tecnico');
            const observacoes = observacoesElement ? observacoesElement.value : '';
            
            const cliente = clientes.find(c => c.nome === tarefa.cliente);
            const tecnico = tecnicos.find(t => t.nome === tarefa.tecnico);
            
            if (!cliente) {
                showNotification('❌ Cliente não encontrado!', 'error');
                return;
            }
            
            if (!cliente.whatsapp) {
                showNotification('❌ WhatsApp do cliente não cadastrado!', 'error');
                return;
            }
            
            try {
                showNotification('📱 Preparando envio via WhatsApp...', 'info');
                
                // Gerar relatório do checklist
                const progresso = Math.round((tarefa.checklist.filter(item => item.concluido).length / tarefa.checklist.length) * 100);
                const concluidos = tarefa.checklist.filter(item => item.concluido);
                const pendentes = tarefa.checklist.filter(item => !item.concluido);
                
                let relatorio = `🔧 *RELATÓRIO DE SERVIÇO TÉCNICO*\n\n`;
                relatorio += `📋 *Tarefa:* ${tarefa.titulo}\n`;
                relatorio += `👤 *Cliente:* ${tarefa.cliente}\n`;
                relatorio += `🔧 *Técnico:* ${tarefa.tecnico}\n`;
                relatorio += `📅 *Data:* ${new Date().toLocaleDateString('pt-BR')}\n`;
                relatorio += `⏰ *Hora:* ${new Date().toLocaleTimeString('pt-BR')}\n\n`;
                
                relatorio += `📊 *PROGRESSO:* ${progresso}% concluído\n`;
                relatorio += `✅ *Itens Concluídos:* ${concluidos.length}/${tarefa.checklist.length}\n\n`;
                
                if (concluidos.length > 0) {
                    relatorio += `✅ *ITENS REALIZADOS:*\n`;
                    concluidos.forEach((item, index) => {
                        relatorio += `${index + 1}. ✅ ${item.item}\n`;
                    });
                    relatorio += `\n`;
                }
                
                if (pendentes.length > 0) {
                    relatorio += `⏳ *ITENS PENDENTES:*\n`;
                    pendentes.forEach((item, index) => {
                        relatorio += `${index + 1}. ⏳ ${item.item}\n`;
                    });
                    relatorio += `\n`;
                }
                
                if (observacoes.trim()) {
                    relatorio += `📝 *OBSERVAÇÕES DO TÉCNICO:*\n${observacoes}\n\n`;
                }
                
                relatorio += `📱 *Enviado via Tecno-Checklist*\n`;
                relatorio += `🔗 Sistema de Gestão de Serviços Técnicos`;
                
                // Gerar PDF primeiro
                showNotification('📄 Gerando PDF...', 'info');
                
                const conteudo = gerarPDFSimples(tarefa);
                
                // Criar elemento com estilos corretos para renderização
                const element = document.createElement('div');
                element.innerHTML = conteudo;
                element.style.position = 'absolute';
                element.style.left = '-9999px';
                element.style.top = '-9999px';
                element.style.width = '800px';
                element.style.backgroundColor = 'white';
                document.body.appendChild(element);
                
                const opt = {
                    margin: 1,
                    filename: `relatorio-tecnico-${tarefa.id}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff'
                    },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                
                
                // Mostrar estado de carregamento
                showNotification('⏳ Gerando PDF...', 'info');
                
                // Gerar PDF e depois abrir WhatsApp
                html2pdf().set(opt).from(element).save().then(() => {
                        // Formatar telefone para WhatsApp
                        const telefone = cliente.whatsapp.replace(/\D/g, '');
                        
                        // Validar se o telefone tem pelo menos 10 dígitos
                        if (telefone.length < 10) {
                            showNotification('❌ Número de WhatsApp inválido! Deve ter pelo menos 10 dígitos.', 'error');
                            return;
                        }
                        
                        const url = `https://wa.me/55${telefone}?text=${encodeURIComponent(relatorio)}`;
                        
                        // Abrir WhatsApp
                        console.log('Tentando abrir WhatsApp com URL:', url);
                        console.log('Telefone:', telefone);
                        console.log('Relatório:', relatorio);
                        const novaJanela = window.open(url, '_blank', 'noopener,noreferrer');
                        
                        if (novaJanela) {
                            showNotification('📱 WhatsApp aberto! PDF baixado. Anexe o arquivo manualmente.', 'success');
                            
                            // Fechar modal após 3 segundos
                            setTimeout(() => {
                                const modal = document.querySelector('.modal');
                                if (modal) modal.remove();
                            }, 3000);
                        } else {
                            // Fallback: copiar para área de transferência
                            console.log('Falha ao abrir janela, tentando fallback');
                            if (navigator.clipboard) {
                                navigator.clipboard.writeText(relatorio).then(() => {
                                    showNotification('📋 Relatório copiado! PDF baixado. Cole no WhatsApp e anexe o PDF.', 'info');
                                }).catch(err => {
                                    console.error('Erro ao copiar para clipboard:', err);
                                    showRelatorioModal(relatorio, cliente.whatsapp);
                                });
                            } else {
                                showRelatorioModal(relatorio, cliente.whatsapp);
                            }
                        }
                    }).catch(error => {
                        console.error('Erro ao gerar PDF:', error);
                        showNotification('❌ Erro ao gerar PDF! Enviando apenas mensagem...', 'warning');
                        
                        // Fallback: enviar apenas mensagem
                        const telefone = cliente.whatsapp.replace(/\D/g, '');
                        const url = `https://wa.me/55${telefone}?text=${encodeURIComponent(relatorio)}`;
                        window.open(url, '_blank', 'noopener,noreferrer');
                }).finally(() => {
                    // Aguardar um pouco antes de remover o elemento
                    setTimeout(() => {
                        if (document.body.contains(element)) {
                            document.body.removeChild(element);
                        }
                    }, 2000);
                });
                
            } catch (error) {
                console.error('Erro ao enviar WhatsApp:', error);
                showNotification('❌ Erro ao preparar envio: ' + error.message, 'error');
            }
        }
        
        function showRelatorioModal(relatorio, telefone) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    max-width: 90%;
                    max-height: 80%;
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                ">
                    <h3 style="margin: 0 0 20px 0; color: #1f2937;">📱 Relatório para WhatsApp</h3>
                    <div style="
                        background: #f9fafb;
                        padding: 20px;
                        border-radius: 10px;
                        margin-bottom: 20px;
                        white-space: pre-wrap;
                        font-family: monospace;
                        font-size: 14px;
                        line-height: 1.5;
                        max-height: 300px;
                        overflow-y: auto;
                    ">${relatorio}</div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="navigator.clipboard.writeText('${relatorio.replace(/'/g, "\\'")}').then(() => showNotification('📋 Copiado!', 'success'))" 
                                style="
                                    flex: 1;
                                    background: #3b82f6;
                                    color: white;
                                    border: none;
                                    padding: 12px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                ">📋 Copiar Texto</button>
                        <button onclick="window.open('https://wa.me/55${telefone}', '_blank')" 
                                style="
                                    flex: 1;
                                    background: #10b981;
                                    color: white;
                                    border: none;
                                    padding: 12px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                ">📱 Abrir WhatsApp</button>
                        <button onclick="this.closest('.modal').remove()" 
                                style="
                                    background: #6b7280;
                                    color: white;
                                    border: none;
                                    padding: 12px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                ">❌ Fechar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function enviarWhatsApp(tarefaId) {
            try {
                console.log('Iniciando enviarWhatsApp para tarefa:', tarefaId);
                
                const tarefa = tarefas.find(t => t.id === tarefaId);
                if (!tarefa) {
                    console.error('Tarefa não encontrada:', tarefaId);
                    showNotification('❌ Tarefa não encontrada!', 'error');
                    return;
                }
                
                const cliente = clientes.find(c => c.nome === tarefa.cliente);
                if (!cliente?.whatsapp) {
                    console.error('WhatsApp não cadastrado para cliente:', tarefa.cliente);
                    showNotification('❌ WhatsApp não cadastrado para este cliente!', 'error');
                    return;
                }
                
                const telefone = cliente.whatsapp.replace(/\D/g, '');
                console.log('Telefone original:', cliente.whatsapp);
                console.log('Telefone formatado:', telefone);
                
                // Validar se o telefone tem pelo menos 10 dígitos
                if (telefone.length < 10) {
                    showNotification('❌ Número de WhatsApp inválido! Deve ter pelo menos 10 dígitos.', 'error');
                    return;
                }
                
                const progresso = tarefa.checklist.length > 0 ? 
                    Math.round((tarefa.checklist.filter(item => item.concluido).length / tarefa.checklist.length) * 100) : 0;
                
                let mensagem = `*Tecno-Checklist - ${tarefa.titulo}*\n\n`;
                mensagem += `📋 *Tarefa:* ${tarefa.titulo}\n`;
                mensagem += `🏢 *Cliente:* ${tarefa.cliente}\n`;
                mensagem += `👨‍🔧 *Técnico:* ${tarefa.tecnico}\n`;
                mensagem += `📅 *Data:* ${new Date(tarefa.data).toLocaleDateString('pt-BR')}\n`;
                mensagem += `⚡ *Prioridade:* ${tarefa.prioridade}\n`;
                mensagem += `📊 *Status:* ${tarefa.status}\n`;
                mensagem += `✅ *Progresso:* ${progresso}%\n\n`;
                
                if (tarefa.checklist.length > 0) {
                    mensagem += `*Checklist:*\n`;
                    tarefa.checklist.forEach((item, index) => {
                        mensagem += `${item.concluido ? '✅' : '⏳'} ${item.item}\n`;
                    });
                    mensagem += `\n`;
                }
                
                mensagem += `📄 *Relatório detalhado foi baixado no seu dispositivo*\n`;
                mensagem += `📎 *Anexe o PDF baixado nesta conversa*\n\n`;
                mensagem += `_Relatório gerado em ${new Date().toLocaleString('pt-BR')}_`;
                
                console.log('Mensagem preparada:', mensagem);
                
                // Gerar PDF e abrir WhatsApp
                showNotification('📄 Gerando PDF...', 'info');
                
                const conteudo = gerarPDFSimples(tarefa);
                
                // Criar elemento com estilos corretos para renderização
                const element = document.createElement('div');
                element.innerHTML = conteudo;
                element.style.position = 'absolute';
                element.style.left = '-9999px';
                element.style.top = '-9999px';
                element.style.width = '800px';
                element.style.backgroundColor = 'white';
                document.body.appendChild(element);
                
                console.log('Iniciando geração de PDF...');
                
                const opt = {
                    margin: 1,
                    filename: `relatorio-tecnico-${tarefa.id}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff'
                    },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                
                
                // Mostrar estado de carregamento
                showNotification('⏳ Gerando PDF...', 'info');
                
                // Gerar PDF e abrir WhatsApp
                html2pdf().set(opt).from(element).save().then(() => {
                        // PDF baixado com sucesso, agora abrir WhatsApp
                        const url = `https://wa.me/55${telefone}?text=${encodeURIComponent(mensagem)}`;
                        
                        const novaJanela = window.open(url, '_blank', 'noopener,noreferrer');
                        
                        if (novaJanela) {
                            showNotification('📱 WhatsApp aberto! PDF baixado. Anexe o arquivo manualmente.', 'success');
                        } else {
                            console.log('Falha ao abrir janela do WhatsApp');
                            showNotification('📋 PDF baixado! Abra o WhatsApp manualmente e anexe o arquivo.', 'info');
                        }
                        
                        // Fechar modal
                        const modal = document.querySelector('.modal');
                        if (modal) modal.remove();
                    }).catch(error => {
                        console.error('Erro ao gerar PDF:', error);
                        showNotification('❌ Erro ao gerar PDF! Enviando apenas mensagem...', 'warning');
                        
                        // Fallback: enviar apenas mensagem
                        const url = `https://wa.me/55${telefone}?text=${encodeURIComponent(mensagem)}`;
                        window.open(url, '_blank', 'noopener,noreferrer');
                }).finally(() => {
                    // Aguardar um pouco antes de remover o elemento
                    setTimeout(() => {
                        if (document.body.contains(element)) {
                            document.body.removeChild(element);
                        }
                    }, 2000);
                });
                
            } catch (error) {
                console.error('Erro geral em enviarWhatsApp:', error);
                showNotification('❌ Erro inesperado!', 'error');
            }
        }

        function formatCNPJ(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/^(\d{2})(\d)/, '$1.$2');
            value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
            value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
            value = value.replace(/(\d{4})(\d)/, '$1-$2');
            e.target.value = value;
            
            // Buscar dados do CNPJ quando tiver 14 dígitos e for válido
            if (value.replace(/\D/g, '').length === 14) {
                if (validarCNPJ(value.replace(/\D/g, ''))) {
                    buscarDadosCNPJ(value.replace(/\D/g, ''));
                } else {
                    showNotification('⚠️ CNPJ inválido. Verifique os dígitos.', 'warning');
                }
            }
        }

        function validarCNPJ(cnpj) {
            // Remove caracteres não numéricos
            cnpj = cnpj.replace(/[^\d]+/g, '');
            
            // Verifica se tem 14 dígitos
            if (cnpj.length !== 14) return false;
            
            // Validação de telefone
            if (/^(\d)\1+$/.test(cnpj)) return false;
            
            // Validação do primeiro dígito verificador
            let soma = 0;
            let peso = 5;
            for (let i = 0; i < 12; i++) {
                soma += parseInt(cnpj.charAt(i)) * peso;
                peso = peso === 2 ? 9 : peso - 1;
            }
            let resto = soma % 11;
            let dv1 = resto < 2 ? 0 : 11 - resto;
            if (parseInt(cnpj.charAt(12)) !== dv1) return false;
            
            // Validação do segundo dígito verificador
            soma = 0;
            peso = 6;
            for (let i = 0; i < 13; i++) {
                soma += parseInt(cnpj.charAt(i)) * peso;
                peso = peso === 2 ? 9 : peso - 1;
            }
            resto = soma % 11;
            let dv2 = resto < 2 ? 0 : 11 - resto;
            if (parseInt(cnpj.charAt(13)) !== dv2) return false;
            
            return true;
        }

        async function buscarDadosCNPJ(cnpj) {
            const cnpjField = document.getElementById('cliente-cnpj');
            const nomeField = document.getElementById('cliente-nome');
            const enderecoField = document.getElementById('cliente-endereco');
            const bairroField = document.getElementById('cliente-bairro');
            const cidadeField = document.getElementById('cliente-cidade');
            const cepField = document.getElementById('cliente-cep');
            const statusElement = document.getElementById('cnpj-status');
            
            try {
                // Adicionar indicador de carregamento
                cnpjField.style.background = '#f0f9ff';
                cnpjField.style.borderColor = '#3b82f6';
                statusElement.innerHTML = '🔍 Buscando...';
                statusElement.style.color = '#3b82f6';
                showNotification('🔍 Buscando dados do CNPJ...', 'info');
                
                // Tentar múltiplas APIs em sequência
                let dados = null;
                let apiUsada = '';
                
                // 1. Tentar BrasilAPI primeiro
                try {
                    statusElement.innerHTML = '🔍 BrasilAPI...';
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 segundos timeout
                    
                    const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        },
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        dados = await response.json();
                        if (dados.razao_social) {
                            apiUsada = 'BrasilAPI';
                        }
                    }
                } catch (error) {
                    console.log('BrasilAPI falhou:', error);
                }
                
                // 2. Se BrasilAPI falhou, tentar CNPJ.wj
                if (!dados || !dados.razao_social) {
                    try {
                        statusElement.innerHTML = '🔍 CNPJ.wj...';
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 segundos timeout
                        
                        const response = await fetch(`https://cnpj.wj.gg/api/cnpj/${cnpj}`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                            },
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (response.ok) {
                            dados = await response.json();
                            if (dados.razao_social) {
                                apiUsada = 'CNPJ.wj';
                            }
                        }
                    } catch (error) {
                        console.log('CNPJ.wj falhou:', error);
                    }
                }
                
                // 3. Se ambas falharam, tentar ReceitaWS como último recurso
                if (!dados || !dados.razao_social) {
                    try {
                        statusElement.innerHTML = '🔍 ReceitaWS...';
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 segundos timeout
                        
                        const response = await fetch(`https://receitaws.com.br/v1/cnpj/${cnpj}`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                            },
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (response.ok) {
                            const receitaData = await response.json();
                            if (receitaData.status === 'OK') {
                                dados = receitaData;
                                apiUsada = 'ReceitaWS';
                            }
                        }
                    } catch (error) {
                        console.log('ReceitaWS falhou:', error);
                    }
                }
                
                if (dados && (dados.razao_social || dados.nome)) {
                    // Preencher campos automaticamente
                    const nomeEmpresa = dados.razao_social || dados.nome || '';
                    const endereco = dados.logradouro || dados.endereco || '';
                    const numero = dados.numero || '';
                    const enderecoCompleto = `${endereco}${numero ? ', ' + numero : ''}`.trim();
                    const bairro = dados.bairro || '';
                    const cidade = dados.municipio || dados.cidade || '';
                    
                    // Formatar CEP automaticamente
                    let cep = dados.cep || '';
                    if (cep && cep.length === 8 && !cep.includes('-')) {
                        cep = cep.replace(/^(\d{5})(\d{3})$/, '$1-$2');
                    }
                    
                    nomeField.value = nomeEmpresa;
                    enderecoField.value = enderecoCompleto;
                    bairroField.value = bairro;
                    cidadeField.value = cidade;
                    cepField.value = cep;
                    
                    // Destacar campos preenchidos
                    const campos = [nomeField, enderecoField, bairroField, cidadeField, cepField];
                    campos.forEach(campo => {
                        if (campo.value.trim()) {
                            campo.style.background = '#f0fdf4';
                            campo.style.borderColor = '#10b981';
                        }
                    });
                    
                    // Atualizar status
                    statusElement.innerHTML = `✅ ${apiUsada}`;
                    statusElement.style.color = '#10b981';
                    
                    // Focar no campo nome para permitir edição
                    setTimeout(() => {
                        nomeField.focus();
                        nomeField.select();
                        showNotification(`✅ Dados do CNPJ carregados via ${apiUsada}! Você pode editar se necessário.`, 'success');
                    }, 500);
                    
                } else {
                    showNotification('⚠️ CNPJ não encontrado em nenhuma API. Preencha os dados manualmente.', 'warning');
                    cnpjField.style.background = '#fef3c7';
                    cnpjField.style.borderColor = '#f59e0b';
                    statusElement.innerHTML = '⚠️ Não encontrado';
                    statusElement.style.color = '#f59e0b';
                }
            } catch (error) {
                console.error('Erro geral ao buscar CNPJ:', error);
                showNotification('❌ Erro ao buscar dados do CNPJ. Preencha manualmente.', 'error');
                cnpjField.style.background = '#fef2f2';
                cnpjField.style.borderColor = '#ef4444';
                statusElement.innerHTML = '❌ Erro';
                statusElement.style.color = '#ef4444';
            } finally {
                // Remover destaque após 5 segundos
                setTimeout(() => {
                    cnpjField.style.background = '';
                    cnpjField.style.borderColor = '';
                    const campos = [nomeField, enderecoField, bairroField, cidadeField, cepField];
                    campos.forEach(campo => {
                        campo.style.background = '';
                        campo.style.borderColor = '';
                    });
                    statusElement.innerHTML = '';
                }, 5000);
            }
        }

        function handleEnter(event, nextFieldId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const nextField = document.getElementById(nextFieldId);
                if (nextField) {
                    nextField.focus();
                } else {
                    // Se não encontrar o próximo campo, tenta clicar no botão de submit
                    const submitBtn = document.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.click();
                    }
                }
            }
        }

        function handleTextareaEnter(event, nextFieldId) {
            if (event.key === 'Enter' && !event.shiftKey) {
                // Shift+Enter = nova linha (comportamento padrão)
                // Enter = navegar para próximo campo
                event.preventDefault();
                const nextField = document.getElementById(nextFieldId);
                if (nextField) {
                    nextField.focus();
                } else {
                    // Se não encontrar o próximo campo, tenta clicar no botão de submit
                    const submitBtn = document.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.click();
                    }
                }
            }
            // Se for Shift+Enter, deixa o comportamento padrão (nova linha)
        }

        function validateField(field, validationType) {
            const value = field.value.trim();
            let isValid = true;
            let message = '';

            switch (validationType) {
                case 'required':
                    isValid = value.length > 0;
                    message = isValid ? '' : 'Este campo é obrigatório';
                    break;
                case 'email':
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    isValid = value.length === 0 || emailRegex.test(value);
                    message = isValid ? '' : 'Digite um e-mail válido';
                    break;
                case 'phone':
                    const phoneRegex = /^\(\d{2}\)\s\d{4,5}-\d{4}$/;
                    isValid = value.length === 0 || phoneRegex.test(value);
                    message = isValid ? '' : 'Digite um telefone válido (XX) XXXXX-XXXX';
                    break;
                case 'cnpj':
                    const cnpjRegex = /^\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}$/;
                    isValid = value.length === 0 || cnpjRegex.test(value);
                    message = isValid ? '' : 'Digite um CNPJ válido (XX.XXX.XXX/XXXX-XX)';
                    break;
                case 'cep':
                    const cepRegex = /^\d{5}-\d{3}$/;
                    isValid = value.length === 0 || cepRegex.test(value);
                    message = isValid ? '' : 'Digite um CEP válido (XXXXX-XXX)';
                    break;
            }

            // Remover mensagens anteriores
            const existingError = field.parentNode.querySelector('.field-error');
            if (existingError) {
                existingError.remove();
            }

            // Adicionar nova mensagem se inválido
            if (!isValid && message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'field-error';
                errorDiv.style.color = '#e74c3c';
                errorDiv.style.fontSize = '0.8rem';
                errorDiv.style.marginTop = '0.25rem';
                errorDiv.textContent = message;
                field.parentNode.appendChild(errorDiv);
            }

            // Atualizar estilo do campo
            field.style.borderColor = isValid ? '' : '#e74c3c';
            
            return isValid;
        }

        function validateForm(formId) {
            const form = document.getElementById(formId);
            const requiredFields = form.querySelectorAll('[required]');
            let allValid = true;

            requiredFields.forEach(field => {
                const isValid = validateField(field, 'required');
                if (!isValid) allValid = false;
            });

            // Validações específicas
            const emailFields = form.querySelectorAll('input[type="email"]');
            emailFields.forEach(field => {
                if (field.value.trim()) {
                    const isValid = validateField(field, 'email');
                    if (!isValid) allValid = false;
                }
            });

            const phoneFields = form.querySelectorAll('input[placeholder*="("]');
            phoneFields.forEach(field => {
                if (field.value.trim()) {
                    const isValid = validateField(field, 'phone');
                    if (!isValid) allValid = false;
                }
            });

            const cnpjField = form.querySelector('#cliente-cnpj');
            if (cnpjField && cnpjField.value.trim()) {
                const isValid = validateField(cnpjField, 'cnpj');
                if (!isValid) allValid = false;
            }

            const cepField = form.querySelector('#cliente-cep');
            if (cepField && cepField.value.trim()) {
                const isValid = validateField(cepField, 'cep');
                if (!isValid) allValid = false;
            }

            return allValid;
        }

        // Debounce para otimizar buscas
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function searchTable(tableType, searchTerm) {
            try {
                const table = document.getElementById(`${tableType}-table`);
                if (!table) {
                    console.warn(`Tabela ${tableType}-table não encontrada`);
                    return;
                }
                
                const rows = table.querySelectorAll('tbody tr');
                const term = searchTerm.toLowerCase();

                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    const shouldShow = text.includes(term);
                    row.style.display = shouldShow ? '' : 'none';
                });
            } catch (error) {
                console.error('Erro na busca da tabela:', error);
                showNotification('❌ Erro ao realizar busca', 'error');
            }
        }

        function showConfirmModal(title, message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.zIndex = '10000';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; text-align: center;">
                    <div style="padding: 2rem;">
                        <div style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3 style="margin-bottom: 1rem; color: #2c3e50;">${title}</h3>
                        <p style="margin-bottom: 2rem; color: #7f8c8d; line-height: 1.5;">${message}</p>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button onclick="this.closest('.modal').remove()" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button onclick="confirmAction()" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.confirmAction = () => {
                onConfirm();
                modal.remove();
                delete window.confirmAction;
            };
        }

        function sortTable(tableId, columnIndex, dataType = 'text') {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Verificar se já está ordenado nesta coluna
            const header = table.querySelectorAll('th')[columnIndex];
            const isAscending = header.classList.contains('sort-asc');
            
            // Otimização: remover classes e ícones de ordenação de todos os headers
            const headers = table.querySelectorAll('th');
            headers.forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                // Usar textContent é mais rápido que innerHTML para texto simples
                const text = th.textContent.replace(' ↑', '').replace(' ↓', '');
                th.textContent = text;
            });
            
            // Ordenar as linhas
            rows.sort((a, b) => {
                const aText = a.cells[columnIndex].textContent.trim();
                const bText = b.cells[columnIndex].textContent.trim();
                
                let comparison = 0;
                
                switch (dataType) {
                    case 'number':
                        comparison = parseFloat(aText) - parseFloat(bText);
                        break;
                    case 'date':
                        comparison = new Date(aText) - new Date(bText);
                        break;
                    default:
                        comparison = aText.localeCompare(bText, 'pt-BR');
                }
                
                return isAscending ? -comparison : comparison;
            });
            
            // Reordenar as linhas na tabela
            rows.forEach(row => tbody.appendChild(row));
            
            // Adicionar classe de ordenação ao header
            header.classList.add(isAscending ? 'sort-desc' : 'sort-asc');
            header.innerHTML += isAscending ? ' ↓' : ' ↑';
        }

        function formatPhone(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/^(\d{2})(\d)/, '($1) $2');
                value = value.replace(/(\d{5})(\d)/, '$1-$2');
            }
            e.target.value = value;
        }

        function formatCEP(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/^(\d{5})(\d)/, '$1-$2');
            e.target.value = value;
        }

        async function loadData() {
            try {
                // Carregar dados do Supabase via funções serverless
                const [clientesData, tecnicosData, tiposData, tarefasData] = await Promise.all([
                    fetch('/api/getData?tabela=clientes').then(r => r.json()),
                    fetch('/api/getData?tabela=tecnicos').then(r => r.json()),
                    fetch('/api/getData?tabela=tipos_tarefa').then(r => r.json()),
                    fetch('/api/getData?tabela=tarefas').then(r => r.json())
                ]);

                clientes = clientesData || [];
                tecnicos = tecnicosData || [];
                tipos = tiposData || [];
                tarefas = tarefasData || [];

                // Processar tarefas: adicionar nomes e checklist para exibição
                tarefas = tarefas.map((tarefa) => {
                    // Buscar objetos completos pelos IDs
                    const clienteObj = clientes.find(c => c.id === tarefa.cliente_id);
                    const tecnicoObj = tecnicos.find(t => t.id === tarefa.tecnico_id);
                    const tipoObj = tipos.find(tp => tp.id === tarefa.tipo_id);
                    
                    return {
                        ...tarefa,
                        // Adicionar nomes para exibição (se não existirem)
                        cliente: tarefa.cliente || (clienteObj ? clienteObj.nome : 'Cliente não encontrado'),
                        tecnico: tarefa.tecnico || (tecnicoObj ? tecnicoObj.nome : 'Técnico não encontrado'),
                        tipo: tarefa.tipo || (tipoObj ? tipoObj.nome : 'Tipo não encontrado'),
                        // Inicializar checklist se não existir
                        checklist: tarefa.checklist || (tipoObj && tipoObj.checklist ? 
                            tipoObj.checklist.map(item => ({ item, concluido: false })) : [])
                    };
                });

                // Atualizar interface
                renderClientes();
                renderTecnicos();
                renderTipos();
                renderTarefas();
                updateStats();
                updateSelects(); // Atualizar selects com os dados carregados

                showNotification('✅ Dados carregados do banco de dados!', 'success');
            } catch (error) {
                console.error('❌ Erro ao carregar dados do banco:', error.message);
                showNotification('⚠️ Erro ao carregar dados do banco. Usando dados locais.', 'warning');
                
                // Fallback para localStorage
                try {
                    const data = localStorage.getItem('tecno-checklist-data');
                    if (data) {
                        const parsed = JSON.parse(data);
                        clientes = parsed.clientes || [];
                        tecnicos = parsed.tecnicos || [];
                        tipos = parsed.tipos || [];
                        tarefas = parsed.tarefas || [];
                    }
                } catch (localError) {
                    console.error('Erro ao carregar dados locais:', localError);
                    clientes = [];
                    tecnicos = [];
                    tipos = [];
                    tarefas = [];
                }
            }
        }

        async function saveData() {
            try {
                // Salvar no Supabase via funções serverless
                const promises = [];
                
                // Salvar clientes
                for (const cliente of clientes) {
                    // Verificar se é um cliente novo (sem created_at) ou existente
                    if (cliente.created_at) {
                        // Atualizar cliente existente
                        promises.push(
                            fetch('/api/updateData', {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    tabela: 'clientes',
                                    id: cliente.id,
                                    dados: cliente
                                })
                            })
                        );
                    } else {
                        // Criar novo cliente
                        promises.push(
                            fetch('/api/saveData', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    tabela: 'clientes',
                                    dados: cliente
                                })
                            })
                        );
                    }
                }

                // Salvar técnicos
                for (const tecnico of tecnicos) {
                    // Verificar se é um técnico novo (sem created_at) ou existente
                    if (tecnico.created_at) {
                        // Atualizar técnico existente
                        promises.push(
                            fetch('/api/updateData', {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    tabela: 'tecnicos',
                                    id: tecnico.id,
                                    dados: tecnico
                                })
                            })
                        );
                    } else {
                        // Criar novo técnico
                        promises.push(
                            fetch('/api/saveData', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    tabela: 'tecnicos',
                                    dados: tecnico
                                })
                            })
                        );
                    }
                }

                // Salvar tipos
                for (const tipo of tipos) {
                    // Verificar se é um tipo novo (sem created_at) ou existente
                    if (tipo.created_at) {
                        // Atualizar tipo existente
                        promises.push(
                            fetch('/api/updateData', {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    tabela: 'tipos_tarefa',
                                    id: tipo.id,
                                    dados: tipo
                                })
                            })
                        );
                    } else {
                        // Criar novo tipo
                        promises.push(
                            fetch('/api/saveData', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    tabela: 'tipos_tarefa',
                                    dados: tipo
                                })
                            })
                        );
                    }
                }

                // Salvar tarefas
                for (const tarefa of tarefas) {
                    // Verificar se é uma tarefa nova (_isNew) ou existente
                    if (tarefa._isNew) {
                        // Criar nova tarefa - enviar apenas campos que existem na tabela do Supabase
                        const tarefaData = {
                            id: tarefa.id,
                            titulo: tarefa.titulo,
                            cliente_id: tarefa.cliente_id,
                            tecnico_id: tarefa.tecnico_id,
                            tipo_id: tarefa.tipo_id,
                            data: tarefa.data,
                            prioridade: tarefa.prioridade,
                            status: tarefa.status,
                            checklist: tarefa.checklist || null,
                            progresso: tarefa.progresso || 0,
                            observacoes: tarefa.observacoes || null
                        };
                        
                        console.log('[Salvando tarefa]', tarefaData);
                        
                        promises.push(
                            fetch('/api/saveData', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    tabela: 'tarefas',
                                    dados: tarefaData
                                })
                            })
                            .then(response => response.json())
                            .then(result => {
                                console.log('[saveData] Tarefa salva:', result);
                                // Marcar tarefa como salva removendo _isNew e adicionando created_at
                                const tarefaIndex = tarefas.findIndex(t => t.id === tarefa.id);
                                if (tarefaIndex !== -1) {
                                    delete tarefas[tarefaIndex]._isNew;
                                    tarefas[tarefaIndex].created_at = result.data?.created_at || new Date().toISOString();
                                }
                                return result;
                            })
                        );
                    } else if (tarefa.created_at) {
                        // Atualizar tarefa existente
                        const tarefaData = {
                            titulo: tarefa.titulo,
                            cliente_id: tarefa.cliente_id,
                            tecnico_id: tarefa.tecnico_id,
                            tipo_id: tarefa.tipo_id,
                            data: tarefa.data,
                            prioridade: tarefa.prioridade,
                            status: tarefa.status,
                            checklist: tarefa.checklist || null,
                            progresso: tarefa.progresso || 0,
                            observacoes: tarefa.observacoes || null
                        };
                        
                        promises.push(
                            fetch('/api/updateData', {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    tabela: 'tarefas',
                                    id: tarefa.id,
                                    dados: tarefaData
                                })
                            })
                        );
                    }
                }

                await Promise.all(promises);
                showNotification('✅ Dados salvos no banco de dados!', 'success');
            } catch (error) {
                console.error('Erro ao salvar dados no banco:', error);
                showNotification('⚠️ Erro ao salvar no banco. Salvando localmente.', 'warning');
                
                // Fallback para localStorage
                try {
                    const data = {
                        clientes, tecnicos, tipos, tarefas
                    };
                    localStorage.setItem('tecno-checklist-data', JSON.stringify(data));
                } catch (localError) {
                    console.error('Erro ao salvar dados locais:', localError);
                    showNotification('❌ Erro ao salvar dados!', 'error');
                }
            }
        }

        function updateStats() {
            const totalClientes = clientes.length;
            const totalTecnicos = tecnicos.length;
            const totalTarefas = tarefas.length;
            const tarefasConcluidas = tarefas.filter(t => t.status === 'concluida').length;
            const tarefasEmAndamento = tarefas.filter(t => t.status === 'em-andamento').length;
            const tarefasPendentes = tarefas.filter(t => t.status === 'pendente').length;
            
            animateNumber('total-clientes', 0, totalClientes, 2000);
            animateNumber('total-tecnicos', 0, totalTecnicos, 2500);
            animateNumber('total-tarefas', 0, tarefasPendentes, 3000);
            animateNumber('tarefas-em-andamento', 0, tarefasEmAndamento, 3200);
            animateNumber('tarefas-concluidas', 0, tarefasConcluidas, 3500);
            
            // Atualizar estatísticas adicionais se existirem
            const statsContainer = document.querySelector('.stats');
            if (statsContainer) {
                const statsHTML = `
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <h3 id="total-clientes">${totalClientes}</h3>
                        <p>Clientes</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-user-tie"></i>
                        <h3 id="total-tecnicos">${totalTecnicos}</h3>
                        <p>Técnicos</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-tasks"></i>
                        <h3 id="total-tarefas">${totalTarefas}</h3>
                        <p>Total de Tarefas</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-circle"></i>
                        <h3 id="tarefas-concluidas">${tarefasConcluidas}</h3>
                        <p>Concluídas</p>
                    </div>
                `;
                statsContainer.innerHTML = statsHTML;
            }
        }

        function animateNumber(elementId, start, end, duration) {
            const element = document.getElementById(elementId);
            const startTime = performance.now();
            
            function updateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const current = Math.floor(start + (end - start) * progress);
                element.textContent = current;
                
                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                }
            }
            
            requestAnimationFrame(updateNumber);
        }

        function startAnimations() {
            const statCards = document.querySelectorAll('.stat-card');
            statCards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.animation = `slideInUp 0.8s ease-out ${index * 0.1}s both`;
                }, 500);
            });
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'info' ? 'spinner fa-spin' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Para notificações de loading, não remover automaticamente
            if (type !== 'info') {
                setTimeout(() => {
                    notification.style.animation = 'slideInRight 0.5s ease-out reverse';
                    setTimeout(() => {
                        notification.remove();
                    }, 500);
                }, 3000);
            }
            
            return notification;
        }

        function showLoadingState(message = 'Carregando...') {
            return showNotification(message, 'info');
        }

        function hideLoadingState(notification) {
            if (notification && notification.parentNode) {
                notification.style.animation = 'slideInRight 0.5s ease-out reverse';
                setTimeout(() => {
                    notification.remove();
                }, 500);
            }
        }

        // Efeitos de hover dinâmicos
        document.addEventListener('mouseover', function(e) {
            if (e.target.classList.contains('stat-card')) {
                e.target.style.transform = 'translateY(-8px) scale(1.02)';
            }
        });

        document.addEventListener('mouseout', function(e) {
            if (e.target.classList.contains('stat-card')) {
                e.target.style.transform = 'translateY(0) scale(1)';
            }
        });

        // ===== DASHBOARD AVANÇADO =====
        let charts = {};
        let notifications = [];
        let activities = [];

        // Inicializar dashboard avançado
        function initAdvancedDashboard() {
            updateDashboardStats();
            createCharts();
            loadRecentActivities();
            loadNotifications();
            startRealTimeUpdates();
        }

        // Atualizar estatísticas do dashboard
        function updateDashboardStats() {
            const clientes = JSON.parse(localStorage.getItem('clientes') || '[]');
            const tecnicos = JSON.parse(localStorage.getItem('tecnicos') || '[]');
            const tarefas = JSON.parse(localStorage.getItem('tarefas') || '[]');
            
            // Contar tarefas por status
            const tarefasPendentes = tarefas.filter(t => t.status === 'pendente').length;
            const tarefasConcluidas = tarefas.filter(t => t.status === 'concluida').length;
            const tarefasHoje = tarefas.filter(t => {
                const hoje = new Date().toISOString().split('T')[0];
                return t.data === hoje && t.status === 'concluida';
            }).length;

            // Atualizar valores
            document.getElementById('total-clientes').textContent = clientes.length;
            document.getElementById('total-tecnicos').textContent = tecnicos.length;
            document.getElementById('total-tarefas').textContent = tarefasPendentes;
            document.getElementById('tarefas-concluidas').textContent = tarefasHoje;

            // Calcular métricas de performance
            const avgTime = calculateAverageCompletionTime(tarefas);
            const successRate = calculateSuccessRate(tarefas);
            
            document.getElementById('avg-completion-time').textContent = avgTime;
            document.getElementById('success-rate').textContent = successRate + '%';
        }

        // Calcular tempo médio de conclusão
        function calculateAverageCompletionTime(tarefas) {
            const concluidas = tarefas.filter(t => t.status === 'concluida' && t.tempoConclusao);
            if (concluidas.length === 0) return '0h';
            
            const totalTime = concluidas.reduce((sum, t) => sum + (t.tempoConclusao || 0), 0);
            const avgTime = totalTime / concluidas.length;
            return Math.round(avgTime) + 'h';
        }

        // Calcular taxa de sucesso
        function calculateSuccessRate(tarefas) {
            if (tarefas.length === 0) return 0;
            const concluidas = tarefas.filter(t => t.status === 'concluida').length;
            return Math.round((concluidas / tarefas.length) * 100);
        }

        // Criar gráficos
        function createCharts() {
            createStatusChart();
            createProductivityChart();
            createTimelineChart();
        }

        // Gráfico de status das tarefas
        function createStatusChart() {
            const ctx = document.getElementById('statusChart');
            if (!ctx) return;

            const tarefas = JSON.parse(localStorage.getItem('tarefas') || '[]');
            const pendentes = tarefas.filter(t => t.status === 'pendente').length;
            const concluidas = tarefas.filter(t => t.status === 'concluida').length;

            charts.status = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pendentes', 'Concluídas'],
                    datasets: [{
                        data: [pendentes, concluidas],
                        backgroundColor: ['#ef4444', '#10b981'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Gráfico de produtividade
        function createProductivityChart() {
            const ctx = document.getElementById('productivityChart');
            if (!ctx) return;

            const tarefas = JSON.parse(localStorage.getItem('tarefas') || '[]');
            const tecnicos = JSON.parse(localStorage.getItem('tecnicos') || '[]');
            
            const productivityData = tecnicos.map(tecnico => {
                const tarefasTecnico = tarefas.filter(t => t.tecnico === tecnico.nome);
                const concluidas = tarefasTecnico.filter(t => t.status === 'concluida').length;
                return {
                    tecnico: tecnico.nome,
                    concluidas: concluidas
                };
            });

            charts.productivity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: productivityData.map(d => d.tecnico),
                    datasets: [{
                        label: 'Tarefas Concluídas',
                        data: productivityData.map(d => d.concluidas),
                        backgroundColor: '#3b82f6',
                        borderColor: '#1e40af',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Gráfico de timeline
        function createTimelineChart() {
            const ctx = document.getElementById('timelineChart');
            if (!ctx) return;

            const tarefas = JSON.parse(localStorage.getItem('tarefas') || '[]');
            const last7Days = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const tarefasDia = tarefas.filter(t => t.data === dateStr);
                last7Days.push({
                    date: dateStr,
                    total: tarefasDia.length,
                    concluidas: tarefasDia.filter(t => t.status === 'concluida').length
                });
            }

            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(d => new Date(d.date).toLocaleDateString('pt-BR')),
                    datasets: [{
                        label: 'Total de Tarefas',
                        data: last7Days.map(d => d.total),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Concluídas',
                        data: last7Days.map(d => d.concluidas),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Carregar atividades recentes
        function loadRecentActivities() {
            const tarefas = JSON.parse(localStorage.getItem('tarefas') || '[]');
            const recentTarefas = tarefas
                .sort((a, b) => new Date(b.data) - new Date(a.data))
                .slice(0, 10);

            const activitiesHtml = recentTarefas.map(tarefa => `
                <div class="activity-item">
                    <div class="activity-icon" style="background: ${tarefa.status === 'concluida' ? '#10b981' : '#3b82f6'};">
                        <i class="fas fa-${tarefa.status === 'concluida' ? 'check' : 'clock'}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${tarefa.titulo}</div>
                        <div class="activity-time">${tarefa.tecnico} • ${new Date(tarefa.data).toLocaleDateString('pt-BR')}</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('recent-activities').innerHTML = activitiesHtml || 
                '<div class="activity-item"><div class="activity-content"><div class="activity-title">Nenhuma atividade recente</div></div></div>';
        }

        // Carregar notificações
        function loadNotifications() {
            const notificationsHtml = notifications.map(notif => `
                <div class="activity-item">
                    <div class="activity-icon" style="background: ${notif.type === 'success' ? '#10b981' : notif.type === 'warning' ? '#f59e0b' : '#ef4444'};">
                        <i class="fas fa-${notif.type === 'success' ? 'check' : notif.type === 'warning' ? 'exclamation' : 'times'}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${notif.title}</div>
                        <div class="activity-time">${notif.time}</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('notifications-list').innerHTML = notificationsHtml || 
                '<div class="activity-item"><div class="activity-content"><div class="activity-title">Nenhuma notificação</div></div></div>';
        }

        // Adicionar notificação
        function addNotification(title, type = 'info') {
            const notification = {
                title: title,
                type: type,
                time: new Date().toLocaleTimeString('pt-BR')
            };
            
            notifications.unshift(notification);
            if (notifications.length > 10) {
                notifications.pop();
            }
            
            loadNotifications();
        }

        // Atualizações em tempo real
        function startRealTimeUpdates() {
            setInterval(() => {
                updateDashboardStats();
                if (charts.status) charts.status.update();
                if (charts.productivity) charts.productivity.update();
                if (charts.timeline) charts.timeline.update();
            }, 30000); // Atualiza a cada 30 segundos
        }

        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initAdvancedDashboard, 1000);
            initNotificationSystem();
            initPWA();
        });

        // ===== PWA (PROGRESSIVE WEB APP) =====
        let deferredPrompt;
        let isInstalled = false;

        // Inicializar PWA
        function initPWA() {
            // Registrar Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration);
                        
                        // Verificar atualizações
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showUpdateNotification();
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Erro ao registrar Service Worker:', error);
                    });
            }

            // Detectar instalação
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallButton();
            });

            // Detectar se já está instalado
            window.addEventListener('appinstalled', () => {
                isInstalled = true;
                hideInstallButton();
                showNotification('Sucesso', 'App instalado com sucesso!', 'success');
            });

            // Detectar modo standalone
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
                isInstalled = true;
                hideInstallButton();
            }

            // Configurar atalhos do teclado
            setupKeyboardShortcuts();
        }

        // Mostrar botão de instalação
        function showInstallButton() {
            if (isInstalled) return;

            const installButton = document.createElement('button');
            installButton.id = 'install-button';
            installButton.className = 'btn btn-primary';
            installButton.innerHTML = '<i class="fas fa-download"></i> Instalar App';
            installButton.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideInUp 0.5s ease-out;
            `;
            
            installButton.addEventListener('click', installApp);
            document.body.appendChild(installButton);
        }

        // Esconder botão de instalação
        function hideInstallButton() {
            const installButton = document.getElementById('install-button');
            if (installButton) {
                installButton.remove();
            }
        }

        // Instalar app
        async function installApp() {
            if (!deferredPrompt) return;

            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('Usuário aceitou a instalação');
            } else {
                console.log('Usuário rejeitou a instalação');
            }
            
            deferredPrompt = null;
            hideInstallButton();
        }

        // Mostrar notificação de atualização
        function showUpdateNotification() {
            const updateNotification = document.createElement('div');
            updateNotification.className = 'notification info';
            updateNotification.innerHTML = `
                <div class="notification-header">
                    <span class="notification-title">Atualização Disponível</span>
                    <button class="notification-close" onclick="this.closest('.notification').remove()">&times;</button>
                </div>
                <div class="notification-message">
                    Uma nova versão do app está disponível. Recarregue a página para atualizar.
                </div>
                <div class="notification-progress"></div>
            `;
            
            document.getElementById('notification-container').appendChild(updateNotification);
            
            setTimeout(() => {
                updateNotification.classList.add('show');
            }, 100);
        }

        // Configurar atalhos do teclado
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + K - Busca global
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    focusSearch();
                }
                
                // Ctrl/Cmd + N - Nova tarefa
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    showSection('tarefas');
                }
                
                // Ctrl/Cmd + D - Dashboard
                if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                    e.preventDefault();
                    showSection('dashboard');
                }
                
                // Escape - Fechar modais
                if (e.key === 'Escape') {
                    const modals = document.querySelectorAll('.modal.active');
                    modals.forEach(modal => modal.remove());
                }
            });
        }

        // Focar na busca
        function focusSearch() {
            const searchInputs = document.querySelectorAll('input[type="text"][placeholder*="Buscar"]');
            if (searchInputs.length > 0) {
                searchInputs[0].focus();
            }
        }

        // Detectar conexão
        function updateConnectionStatus() {
            const isOnline = navigator.onLine;
            const statusElement = document.getElementById('connection-status');
            
            if (statusElement) {
                statusElement.textContent = isOnline ? 'Online' : 'Offline';
                statusElement.className = isOnline ? 'online' : 'offline';
            }
            
            if (!isOnline) {
                showNotification('Offline', 'Você está offline. Algumas funcionalidades podem estar limitadas.', 'warning');
            }
        }

        // Monitorar status da conexão
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);

        // Sincronizar dados quando voltar online
        window.addEventListener('online', () => {
            if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                navigator.serviceWorker.ready.then(registration => {
                    return registration.sync.register('background-sync');
                });
            }
        });

        // Adicionar indicador de status da conexão
        function addConnectionStatus() {
            const statusIndicator = document.createElement('div');
            statusIndicator.id = 'connection-status';
            statusIndicator.style.cssText = `
                position: fixed;
                top: 10px;
                left: 10px;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 600;
                z-index: 1000;
                transition: all 0.3s ease;
            `;
            document.body.appendChild(statusIndicator);
            updateConnectionStatus();
        }

        // Inicializar indicador de status
        addConnectionStatus();

        // ===== SISTEMA DE NOTIFICAÇÕES =====
        let notificationQueue = [];
        let notificationHistory = JSON.parse(localStorage.getItem('notificationHistory') || '[]');

        // Inicializar sistema de notificações
        function initNotificationSystem() {
            // Solicitar permissão para notificações
            if ('Notification' in window) {
                Notification.requestPermission();
            }
            
            // Carregar histórico de notificações
            loadNotificationHistory();
            
            // Iniciar monitoramento de eventos
            startEventMonitoring();
        }

        // Mostrar notificação
        function showNotification(title, message, type = 'info', duration = 5000) {
            const notification = {
                id: Date.now(),
                title: title,
                message: message,
                type: type,
                timestamp: new Date(),
                read: false
            };

            // Adicionar ao histórico
            notificationHistory.unshift(notification);
            if (notificationHistory.length > 100) {
                notificationHistory.pop();
            }
            localStorage.setItem('notificationHistory', JSON.stringify(notificationHistory));

            // Mostrar notificação visual
            createNotificationElement(notification);
            
            // Mostrar notificação do navegador se permitido
            if (Notification.permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: '/favicon.ico',
                    tag: 'tecno-checklist'
                });
            }

            // Atualizar contador
            updateNotificationCount();
        }

        // Criar elemento de notificação
        function createNotificationElement(notification) {
            const container = document.getElementById('notification-container');
            const element = document.createElement('div');
            element.className = `notification ${notification.type}`;
            element.innerHTML = `
                <div class="notification-header">
                    <span class="notification-title">${notification.title}</span>
                    <button class="notification-close" onclick="closeNotification(this)">&times;</button>
                </div>
                <div class="notification-message">${notification.message}</div>
                <div class="notification-progress"></div>
            `;

            container.appendChild(element);

            // Animar entrada
            setTimeout(() => {
                element.classList.add('show');
            }, 100);

            // Auto-remover após duração
            setTimeout(() => {
                closeNotification(element.querySelector('.notification-close'));
            }, 5000);
        }

        // Fechar notificação
        function closeNotification(button) {
            const notification = button.closest('.notification');
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }

        // Atualizar contador de notificações
        function updateNotificationCount() {
            const unreadCount = notificationHistory.filter(n => !n.read).length;
            const badge = document.getElementById('notification-count');
            if (badge) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Carregar histórico de notificações
        function loadNotificationHistory() {
            const container = document.getElementById('notification-list-dropdown');
            if (!container) return;

            const recentNotifications = notificationHistory.slice(0, 10);
            const html = recentNotifications.map(notification => `
                <div class="notification-item ${!notification.read ? 'unread' : ''}" 
                     onclick="markAsRead(${notification.id})">
                    <div class="notification-item-title">${notification.title}</div>
                    <div class="notification-item-message">${notification.message}</div>
                    <div class="notification-item-time">${formatTime(notification.timestamp)}</div>
                </div>
            `).join('');

            container.innerHTML = html || '<div class="notification-item"><div class="notification-item-title">Nenhuma notificação</div></div>';
        }

        // Marcar como lida
        function markAsRead(notificationId) {
            const notification = notificationHistory.find(n => n.id === notificationId);
            if (notification) {
                notification.read = true;
                localStorage.setItem('notificationHistory', JSON.stringify(notificationHistory));
                loadNotificationHistory();
                updateNotificationCount();
            }
        }

        // Limpar todas as notificações
        function clearAllNotifications() {
            notificationHistory = [];
            localStorage.setItem('notificationHistory', JSON.stringify(notificationHistory));
            loadNotificationHistory();
            updateNotificationCount();
        }

        // Alternar dropdown de notificações
        function toggleNotificationDropdown() {
            const dropdown = document.getElementById('notification-dropdown');
            dropdown.classList.toggle('show');
        }

        // Fechar dropdown ao clicar fora
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('notification-dropdown');
            const bell = document.querySelector('.notification-bell');
            if (dropdown && !dropdown.contains(e.target) && !bell.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Formatar tempo
        function formatTime(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diff = now - time;
            
            if (diff < 60000) return 'Agora';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'min atrás';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h atrás';
            return time.toLocaleDateString('pt-BR');
        }

        // Monitorar eventos do sistema
        function startEventMonitoring() {
            // Monitorar mudanças no localStorage
            window.addEventListener('storage', function(e) {
                if (e.key === 'tarefas') {
                    showNotification('Tarefa Atualizada', 'Uma tarefa foi modificada por outro usuário', 'info');
                }
            });

            // Monitorar mudanças de status de tarefas
            const originalSetItem = localStorage.setItem;
            localStorage.setItem = function(key, value) {
                if (key === 'tarefas') {
                    const oldTarefas = JSON.parse(localStorage.getItem('tarefas') || '[]');
                    const newTarefas = JSON.parse(value);
                    
                    // Detectar novas tarefas
                    if (newTarefas.length > oldTarefas.length) {
                        const novaTarefa = newTarefas[newTarefas.length - 1];
                        showNotification('Nova Tarefa', `Tarefa "${novaTarefa.titulo}" foi criada`, 'success');
                    }
                    
                    // Detectar mudanças de status
                    newTarefas.forEach(tarefa => {
                        const oldTarefa = oldTarefas.find(t => t.id === tarefa.id);
                        if (oldTarefa && oldTarefa.status !== tarefa.status) {
                            if (tarefa.status === 'concluida') {
                                showNotification('Tarefa Concluída', `Tarefa "${tarefa.titulo}" foi concluída`, 'success');
                            }
                        }
                    });
                }
                
                return originalSetItem.apply(this, arguments);
            };
        }

        // Notificações automáticas baseadas em regras
        function checkAutomaticNotifications() {
            const tarefas = JSON.parse(localStorage.getItem('tarefas') || '[]');
            const hoje = new Date().toISOString().split('T')[0];
            
            // Tarefas vencidas
            const vencidas = tarefas.filter(t => t.data < hoje && t.status === 'pendente');
            if (vencidas.length > 0) {
                showNotification('Tarefas Vencidas', `${vencidas.length} tarefa(s) vencida(s)`, 'warning');
            }
            
            // Tarefas para hoje
            const hojeTarefas = tarefas.filter(t => t.data === hoje && t.status === 'pendente');
            if (hojeTarefas.length > 0) {
                showNotification('Tarefas de Hoje', `${hojeTarefas.length} tarefa(s) para hoje`, 'info');
            }
        }

        // Verificar notificações a cada 5 minutos
        setInterval(checkAutomaticNotifications, 300000);

        // ===== SISTEMA DE COMENTÁRIOS E ANEXOS =====
        let currentAttachments = [];
        let comments = JSON.parse(localStorage.getItem('comments') || '{}');

        // Adicionar comentário
        function addComment(tarefaId) {
            const commentInput = document.getElementById('comment-input');
            const content = commentInput.value.trim();
            
            if (!content && currentAttachments.length === 0) {
                showNotification('Erro', 'Digite um comentário ou anexe um arquivo', 'error');
                return;
            }

            const comment = {
                id: Date.now(),
                tarefaId: tarefaId,
                content: content,
                author: currentUser ? currentUser.nome : 'Usuário',
                timestamp: new Date(),
                attachments: [...currentAttachments]
            };

            // Salvar comentário
            if (!comments[tarefaId]) {
                comments[tarefaId] = [];
            }
            comments[tarefaId].push(comment);
            localStorage.setItem('comments', JSON.stringify(comments));

            // Limpar formulário
            commentInput.value = '';
            currentAttachments = [];
            updateFileUploadLabel();

            // Recarregar comentários
            loadComments(tarefaId);

            // Notificação
            showNotification('Sucesso', 'Comentário adicionado com sucesso', 'success');
        }

        // Carregar comentários
        function loadComments(tarefaId) {
            const container = document.getElementById(`comments-list-${tarefaId}`);
            if (!container) return;

            const tarefaComments = comments[tarefaId] || [];
            
            if (tarefaComments.length === 0) {
                container.innerHTML = '<div class="empty-comments">Nenhum comentário ainda</div>';
                return;
            }

            const html = tarefaComments.map(comment => `
                <div class="comment-item">
                    <div class="comment-header">
                        <span class="comment-author">${comment.author}</span>
                        <span class="comment-time">${formatTime(comment.timestamp)}</span>
                    </div>
                    <div class="comment-content">${comment.content}</div>
                    ${comment.attachments.length > 0 ? `
                        <div class="comment-attachments">
                            ${comment.attachments.map(attachment => `
                                <a href="${attachment.url}" target="_blank" class="attachment-item">
                                    <i class="fas fa-${getFileIcon(attachment.type)} attachment-icon"></i>
                                    ${attachment.name}
                                </a>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // Obter ícone do arquivo
        function getFileIcon(type) {
            if (type.startsWith('image/')) return 'image';
            if (type === 'application/pdf') return 'file-pdf';
            if (type.includes('word')) return 'file-word';
            if (type.includes('excel')) return 'file-excel';
            if (type.includes('powerpoint')) return 'file-powerpoint';
            return 'file';
        }

        // Atualizar label do upload
        function updateFileUploadLabel() {
            const label = document.querySelector('.file-upload-label');
            if (currentAttachments.length > 0) {
                label.innerHTML = `<i class="fas fa-paperclip"></i> ${currentAttachments.length} arquivo(s) selecionado(s)`;
                label.style.background = 'var(--primary)';
                label.style.color = 'white';
            } else {
                label.innerHTML = '<i class="fas fa-paperclip"></i> Anexar Arquivo';
                label.style.background = 'var(--gray-100)';
                label.style.color = 'var(--gray-700)';
            }
        }

        // Processar upload de arquivos
        document.addEventListener('change', function(e) {
            if (e.target.id === 'file-upload') {
                const files = Array.from(e.target.files);
                currentAttachments = [];

                files.forEach(file => {
                    if (file.size > 10 * 1024 * 1024) { // 10MB
                        showNotification('Erro', `Arquivo ${file.name} é muito grande (máximo 10MB)`, 'error');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const attachment = {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            url: e.target.result,
                            data: e.target.result
                        };
                        currentAttachments.push(attachment);
                        updateFileUploadLabel();
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        // Visualizar imagem em modal
        function viewImage(imageUrl) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 90vw; max-height: 90vh; text-align: center;">
                    <div class="modal-header">
                        <h3 class="modal-title">Visualizar Imagem</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 1rem;">
                        <img src="${imageUrl}" class="modal-image" alt="Imagem anexada">
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Inicializar sistema de comentários quando abrir modal
        function initCommentsSystem(tarefaId) {
            loadComments(tarefaId);
            currentAttachments = [];
            updateFileUploadLabel();
        }

        // Inicializar sistema de backup
        document.addEventListener('DOMContentLoaded', function() {
            initBackupSystem();
        });

        // ===== SISTEMA DE BACKUP E SINCRONIZAÇÃO =====
        let backups = JSON.parse(localStorage.getItem('backups') || '[]');
        let syncStatus = 'online';

        // Inicializar sistema de backup
        function initBackupSystem() {
            updateBackupStats();
            startAutoBackup();
        }

        // Criar backup
        function createBackup() {
            const backupData = {
                id: Date.now(),
                timestamp: new Date(),
                data: {
                    clientes: JSON.parse(localStorage.getItem('clientes') || '[]'),
                    tecnicos: JSON.parse(localStorage.getItem('tecnicos') || '[]'),
                    tarefas: JSON.parse(localStorage.getItem('tarefas') || '[]'),
                    tiposDeTarefa: JSON.parse(localStorage.getItem('tiposDeTarefa') || '{}'),
                    usuarios: JSON.parse(localStorage.getItem('usuarios') || '[]'),
                    comments: JSON.parse(localStorage.getItem('comments') || '{}'),
                },
                size: JSON.stringify(localStorage).length
            };

            backups.unshift(backupData);
            if (backups.length > 10) backups = backups.slice(0, 10);
            
            localStorage.setItem('backups', JSON.stringify(backups));
            updateBackupStats();
            showNotification('Sucesso', 'Backup criado com sucesso!', 'success');
        }

        // Restaurar backup
        function restoreBackup() {
            if (backups.length === 0) {
                showNotification('Erro', 'Nenhum backup disponível', 'error');
                return;
            }
            showNotification('Info', 'Selecione um backup na lista para restaurar', 'info');
        }

        // Exportar dados
        function exportData() {
            const data = {
                clientes: JSON.parse(localStorage.getItem('clientes') || '[]'),
                tecnicos: JSON.parse(localStorage.getItem('tecnicos') || '[]'),
                tarefas: JSON.parse(localStorage.getItem('tarefas') || '[]'),
                tiposDeTarefa: JSON.parse(localStorage.getItem('tiposDeTarefa') || '{}'),
                usuarios: JSON.parse(localStorage.getItem('usuarios') || '[]'),
                comments: JSON.parse(localStorage.getItem('comments') || '{}'),
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tecno-checklist-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Sucesso', 'Dados exportados com sucesso!', 'success');
        }

        // Importar dados
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (confirm('Tem certeza que deseja importar estes dados?')) {
                                Object.keys(data).forEach(key => {
                                    if (key !== 'exportDate') {
                                        localStorage.setItem(key, JSON.stringify(data[key]));
                                    }
                                });
                                showNotification('Sucesso', 'Dados importados com sucesso!', 'success');
                                setTimeout(() => location.reload(), 2000);
                            }
                        } catch (error) {
                            showNotification('Erro', 'Arquivo inválido', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Atualizar estatísticas
        function updateBackupStats() {
            document.getElementById('backup-count').textContent = backups.length;
            if (backups.length > 0) {
                const lastBackup = new Date(backups[0].timestamp);
                document.getElementById('last-backup').textContent = lastBackup.toLocaleDateString('pt-BR');
            } else {
                document.getElementById('last-backup').textContent = 'Nunca';
            }
        }

        // Backup automático
        function startAutoBackup() {
            setInterval(() => {
                if (navigator.onLine) createBackup();
            }, 30 * 60 * 1000);
        }

        // ===== SISTEMA DE RELATÓRIOS AVANÇADOS =====
        let currentReport = null;
        let reportFilters = {
            dateFrom: '',
            dateTo: '',
            tecnico: '',
            cliente: '',
            status: '',
            tipo: ''
        };

        // Gerar relatório
        function generateReport(type) {
            console.log('Gerando relatório:', type);
            currentReport = type;
            showReportModal();
        }

        // Mostrar modal de relatório
        function showReportModal() {
            console.log('Mostrando modal de relatório');
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3 class="modal-title">Relatório de ${getReportTitle(currentReport)}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="report-filters">
                        <div class="filters-grid">
                            <div class="filter-group">
                                <label class="filter-label">Data Inicial:</label>
                                <input type="date" class="filter-input" id="report-date-from" value="${reportFilters.dateFrom}">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Data Final:</label>
                                <input type="date" class="filter-input" id="report-date-to" value="${reportFilters.dateTo}">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Técnico:</label>
                                <select class="filter-input" id="report-tecnico">
                                    <option value="">Todos</option>
                                    ${getTecnicosOptions()}
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Cliente:</label>
                                <select class="filter-input" id="report-cliente">
                                    <option value="">Todos</option>
                                    ${getClientesOptions()}
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Status:</label>
                                <select class="filter-input" id="report-status">
                                    <option value="">Todos</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="concluida">Concluída</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Tipo:</label>
                                <select class="filter-input" id="report-tipo">
                                    <option value="">Todos</option>
                                    ${getTiposOptions()}
                                </select>
                            </div>
                        </div>
                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button onclick="applyReportFilters()" class="btn btn-primary">
                                <i class="fas fa-search"></i> Gerar Relatório
                            </button>
                            <button onclick="clearReportFilters()" class="btn btn-secondary">
                                <i class="fas fa-eraser"></i> Limpar Filtros
                            </button>
                        </div>
                    </div>
                    <div id="report-content">
                        <div class="report-loading">
                            <i class="fas fa-spinner fa-spin"></i> Gerando relatório...
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            applyReportFilters();
        }

        // Aplicar filtros do relatório
        function applyReportFilters() {
            reportFilters = {
                dateFrom: document.getElementById('report-date-from').value,
                dateTo: document.getElementById('report-date-to').value,
                tecnico: document.getElementById('report-tecnico').value,
                cliente: document.getElementById('report-cliente').value,
                status: document.getElementById('report-status').value,
                tipo: document.getElementById('report-tipo').value
            };
            
            generateReportContent();
        }

        // Limpar filtros
        function clearReportFilters() {
            document.getElementById('report-date-from').value = '';
            document.getElementById('report-date-to').value = '';
            document.getElementById('report-tecnico').value = '';
            document.getElementById('report-cliente').value = '';
            document.getElementById('report-status').value = '';
            document.getElementById('report-tipo').value = '';
            applyReportFilters();
        }

        // Gerar conteúdo do relatório
        function generateReportContent() {
            const content = document.getElementById('report-content');
            const data = getFilteredData();
            
            if (data.length === 0) {
                content.innerHTML = `
                    <div class="report-empty">
                        <i class="fas fa-chart-bar"></i>
                        <h3>Nenhum dado encontrado</h3>
                        <p>Ajuste os filtros para gerar o relatório</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Resumo
            html += generateReportSummary(data);
            
            // Tabela
            html += generateReportTable(data);
            
            // Gráficos
            html += generateReportCharts(data);
            
            content.innerHTML = html;
            
            // Criar gráficos
            setTimeout(() => {
                createReportCharts(data);
            }, 100);
        }

        // Obter dados filtrados
        function getFilteredData() {
            let tarefas = JSON.parse(localStorage.getItem('tarefas') || '[]');
            
            // Aplicar filtros
            if (reportFilters.dateFrom) {
                tarefas = tarefas.filter(t => t.data >= reportFilters.dateFrom);
            }
            if (reportFilters.dateTo) {
                tarefas = tarefas.filter(t => t.data <= reportFilters.dateTo);
            }
            if (reportFilters.tecnico) {
                tarefas = tarefas.filter(t => t.tecnico === reportFilters.tecnico);
            }
            if (reportFilters.cliente) {
                tarefas = tarefas.filter(t => t.cliente === reportFilters.cliente);
            }
            if (reportFilters.status) {
                tarefas = tarefas.filter(t => t.status === reportFilters.status);
            }
            if (reportFilters.tipo) {
                tarefas = tarefas.filter(t => t.tipo === reportFilters.tipo);
            }
            
            return tarefas;
        }

        // Gerar resumo do relatório
        function generateReportSummary(data) {
            const total = data.length;
            const concluidas = data.filter(t => t.status === 'concluida').length;
            const pendentes = data.filter(t => t.status === 'pendente').length;
            const percentual = total > 0 ? Math.round((concluidas / total) * 100) : 0;
            
            return `
                <div class="report-summary">
                    <div class="summary-card">
                        <div class="summary-value">${total}</div>
                        <div class="summary-label">Total de Tarefas</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${concluidas}</div>
                        <div class="summary-label">Concluídas</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${pendentes}</div>
                        <div class="summary-label">Pendentes</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${percentual}%</div>
                        <div class="summary-label">Taxa de Conclusão</div>
                    </div>
                </div>
            `;
        }

        // Gerar tabela do relatório
        function generateReportTable(data) {
            return `
                <div class="report-preview">
                    <h3>Detalhes das Tarefas</h3>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Título</th>
                                <th>Cliente</th>
                                <th>Técnico</th>
                                <th>Data</th>
                                <th>Status</th>
                                <th>Progresso</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(tarefa => `
                                <tr>
                                    <td>${tarefa.titulo}</td>
                                    <td>${tarefa.cliente}</td>
                                    <td>${tarefa.tecnico}</td>
                                    <td>${new Date(tarefa.data).toLocaleDateString('pt-BR')}</td>
                                    <td>
                                        <span class="badge ${tarefa.status === 'concluida' ? 'success' : 'warning'}">
                                            ${tarefa.status === 'concluida' ? 'Concluída' : 'Pendente'}
                                        </span>
                                    </td>
                                    <td>
                                        ${tarefa.checklist ? Math.round((tarefa.checklist.filter(item => item.concluido).length / tarefa.checklist.length) * 100) : 0}%
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Gerar gráficos do relatório
        function generateReportCharts(data) {
            return `
                <div class="report-charts">
                    <div class="chart-card">
                        <div class="chart-title">Status das Tarefas</div>
                        <div class="chart-container-report">
                            <canvas id="report-status-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Produtividade por Técnico</div>
                        <div class="chart-container-report">
                            <canvas id="report-productivity-chart"></canvas>
                        </div>
                    </div>
                </div>
            `;
        }

        // Criar gráficos do relatório
        function createReportCharts(data) {
            // Gráfico de status
            const statusCtx = document.getElementById('report-status-chart');
            if (statusCtx) {
                const concluidas = data.filter(t => t.status === 'concluida').length;
                const pendentes = data.filter(t => t.status === 'pendente').length;
                
                new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Concluídas', 'Pendentes'],
                        datasets: [{
                            data: [concluidas, pendentes],
                            backgroundColor: ['#10b981', '#f59e0b']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Gráfico de produtividade
            const productivityCtx = document.getElementById('report-productivity-chart');
            if (productivityCtx) {
                const tecnicos = [...new Set(data.map(t => t.tecnico))];
                const productivityData = tecnicos.map(tecnico => {
                    const tarefasTecnico = data.filter(t => t.tecnico === tecnico);
                    return {
                        tecnico: tecnico,
                        concluidas: tarefasTecnico.filter(t => t.status === 'concluida').length,
                        total: tarefasTecnico.length
                    };
                });
                
                new Chart(productivityCtx, {
                    type: 'bar',
                    data: {
                        labels: productivityData.map(d => d.tecnico),
                        datasets: [{
                            label: 'Tarefas Concluídas',
                            data: productivityData.map(d => d.concluidas),
                            backgroundColor: '#3b82f6'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        }

        // Funções auxiliares
        function getReportTitle(type) {
            const titles = {
                'tarefas': 'Tarefas',
                'produtividade': 'Produtividade',
                'clientes': 'Clientes'
            };
            return titles[type] || 'Relatório';
        }

        function getTecnicosOptions() {
            const tecnicos = JSON.parse(localStorage.getItem('tecnicos') || '[]');
            return tecnicos.map(t => `<option value="${t.nome}">${t.nome}</option>`).join('');
        }

        function getClientesOptions() {
            const clientes = JSON.parse(localStorage.getItem('clientes') || '[]');
            return clientes.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');
        }

        function getTiposOptions() {
            const tipos = JSON.parse(localStorage.getItem('tiposDeTarefa') || '{}');
            return Object.keys(tipos).map(t => `<option value="${t}">${t}</option>`).join('');
        }

        // Exportar relatório
        function exportReport(format) {
            if (!currentReport) {
                showNotification('Erro', 'Gere um relatório primeiro', 'error');
                return;
            }
            
            const data = getFilteredData();
            if (data.length === 0) {
                showNotification('Erro', 'Nenhum dado para exportar', 'error');
                return;
            }
            
            if (format === 'pdf') {
                exportToPDF(data);
            } else if (format === 'excel') {
                exportToExcel(data);
            } else if (format === 'csv') {
                exportToCSV(data);
            }
        }

        // Exportar para PDF
        function exportToPDF(data) {
            // Usar a função existente de PDF
            showNotification('Info', 'Exportando para PDF...', 'info');
            // Implementar exportação PDF específica para relatórios
        }

        // Exportar para Excel
        function exportToExcel(data) {
            const csv = convertToCSV(data);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio-${currentReport}-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Sucesso', 'Relatório exportado com sucesso!', 'success');
        }

        // Exportar para CSV
        function exportToCSV(data) {
            const csv = convertToCSV(data);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio-${currentReport}-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Sucesso', 'Relatório exportado com sucesso!', 'success');
        }

        // Converter para CSV
        function convertToCSV(data) {
            const headers = ['Título', 'Cliente', 'Técnico', 'Data', 'Status', 'Progresso'];
            const rows = data.map(tarefa => [
                tarefa.titulo,
                tarefa.cliente,
                tarefa.tecnico,
                new Date(tarefa.data).toLocaleDateString('pt-BR'),
                tarefa.status === 'concluida' ? 'Concluída' : 'Pendente',
                tarefa.checklist ? Math.round((tarefa.checklist.filter(item => item.concluido).length / tarefa.checklist.length) * 100) : 0
            ]);
            
            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        // Mostrar filtros avançados
        function showReportFilters() {
            showReportModal();
        }

        // ===== SISTEMA DE GEOLOCALIZAÇÃO =====
        let currentLocation = null;
        let locationHistory = JSON.parse(localStorage.getItem('locationHistory') || '[]');
        let isTracking = false;
        let watchId = null;

        // Inicializar sistema de geolocalização
        function initLocationSystem() {
            updateLocationStatus();
            loadLocationHistory();
        }

        // Solicitar permissão de localização
        function requestLocationPermission() {
            if (!navigator.geolocation) {
                showNotification('Erro', 'Geolocalização não suportada neste navegador', 'error');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date()
                    };
                    
                    updateLocationDisplay();
                    addLocationToHistory();
                    showNotification('Sucesso', 'Localização obtida com sucesso!', 'success');
                },
                (error) => {
                    let message = 'Erro ao obter localização: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message += 'Permissão negada';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message += 'Localização indisponível';
                            break;
                        case error.TIMEOUT:
                            message += 'Tempo esgotado';
                            break;
                        default:
                            message += 'Erro desconhecido';
                            break;
                    }
                    showNotification('Erro', message, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000
                }
            );
        }

        // Atualizar exibição da localização
        function updateLocationDisplay() {
            if (currentLocation) {
                document.getElementById('current-location').textContent = 
                    `${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}`;
                document.getElementById('location-accuracy').textContent = 
                    Math.round(currentLocation.accuracy) + 'm';
                document.getElementById('location-status').textContent = 'Online';
                document.getElementById('location-status').className = 'location-detail-value';
            }
        }

        // Adicionar localização ao histórico
        function addLocationToHistory() {
            if (currentLocation) {
                const locationData = {
                    ...currentLocation,
                    address: 'Localização atual', // Em uma implementação real, você usaria uma API de geocodificação
                    id: Date.now()
                };
                
                locationHistory.unshift(locationData);
                
                // Manter apenas os últimos 50 registros
                if (locationHistory.length > 50) {
                    locationHistory = locationHistory.slice(0, 50);
                }
                
                localStorage.setItem('locationHistory', JSON.stringify(locationHistory));
                loadLocationHistory();
            }
        }

        // Carregar histórico de localização
        function loadLocationHistory() {
            // Esta função será chamada quando o modal de histórico for aberto
        }

        // Mostrar histórico de localização
        function showLocationHistory() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Histórico de Localização</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="location-history">
                        ${locationHistory.length === 0 ? `
                            <div class="location-permission">
                                <i class="fas fa-map-marker-alt"></i>
                                <h3>Nenhuma localização registrada</h3>
                                <p>Ative a localização para começar a rastrear</p>
                            </div>
                        ` : locationHistory.map(location => `
                            <div class="location-item">
                                <div class="location-item-info">
                                    <div class="location-item-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <div class="location-item-details">
                                        <div class="location-item-address">${location.address || 'Localização'}</div>
                                        <div class="location-item-time">${new Date(location.timestamp).toLocaleString('pt-BR')}</div>
                                    </div>
                                </div>
                                <div class="location-item-distance">
                                    ${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Mostrar mapa de localização
        function showLocationMap() {
            if (!currentLocation) {
                showNotification('Erro', 'Nenhuma localização disponível', 'error');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 1000px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Mapa de Localização</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 1rem;">
                        <div class="location-map" id="location-map">
                            <div style="text-align: center;">
                                <i class="fas fa-map" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <p>Mapa interativo seria exibido aqui</p>
                                <p style="font-size: 0.875rem; color: var(--gray-500);">
                                    Coordenadas: ${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}
                                </p>
                                <p style="font-size: 0.875rem; color: var(--gray-500);">
                                    Precisão: ${Math.round(currentLocation.accuracy)}m
                                </p>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; text-align: center;">
                            <a href="https://www.google.com/maps?q=${currentLocation.latitude},${currentLocation.longitude}" 
                               target="_blank" class="btn btn-primary">
                                <i class="fas fa-external-link-alt"></i> Abrir no Google Maps
                            </a>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Iniciar rastreamento contínuo
        function startLocationTracking() {
            if (isTracking) return;

            if (!navigator.geolocation) {
                showNotification('Erro', 'Geolocalização não suportada', 'error');
                return;
            }

            isTracking = true;
            showLocationTrackingWidget();

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date()
                    };
                    
                    updateLocationDisplay();
                    updateLocationTrackingWidget();
                    
                    // Adicionar ao histórico a cada 5 minutos
                    const lastLocation = locationHistory[0];
                    if (!lastLocation || 
                        (new Date() - new Date(lastLocation.timestamp)) > 5 * 60 * 1000) {
                        addLocationToHistory();
                    }
                },
                (error) => {
                    showNotification('Erro', 'Erro no rastreamento de localização', 'error');
                    stopLocationTracking();
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 30000
                }
            );
        }

        // Parar rastreamento
        function stopLocationTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            isTracking = false;
            hideLocationTrackingWidget();
        }

        // Mostrar widget de rastreamento
        function showLocationTrackingWidget() {
            const widget = document.getElementById('location-tracking-widget');
            widget.style.display = 'block';
        }

        // Esconder widget de rastreamento
        function hideLocationTrackingWidget() {
            const widget = document.getElementById('location-tracking-widget');
            widget.style.display = 'none';
        }

        // Atualizar widget de rastreamento
        function updateLocationTrackingWidget() {
            if (currentLocation) {
                document.getElementById('location-tracking-coords').textContent = 
                    `${currentLocation.latitude.toFixed(4)}, ${currentLocation.longitude.toFixed(4)}`;
            }
        }

        // Atualizar status da localização
        function updateLocationStatus() {
            const status = navigator.onLine ? 'Online' : 'Offline';
            document.getElementById('location-status').textContent = status;
        }

        // Inicializar sistema de localização
        document.addEventListener('DOMContentLoaded', function() {
            initLocationSystem();
            initApprovalSystem();
        });

        // ===== SISTEMA DE APROVAÇÃO DE TAREFAS =====
        let approvalQueue = JSON.parse(localStorage.getItem('approvalQueue') || '[]');
        let approvalHistory = JSON.parse(localStorage.getItem('approvalHistory') || '[]');

        // Inicializar sistema de aprovação
        function initApprovalSystem() {
            updateApprovalStats();
        }

        // Atualizar estatísticas de aprovação
        function updateApprovalStats() {
            const pending = approvalQueue.filter(item => item.status === 'pending').length;
            const today = new Date().toDateString();
            const approvedToday = approvalHistory.filter(item => 
                item.status === 'approved' && new Date(item.timestamp).toDateString() === today
            ).length;
            const rejectedToday = approvalHistory.filter(item => 
                item.status === 'rejected' && new Date(item.timestamp).toDateString() === today
            ).length;

            document.getElementById('pending-approvals').textContent = pending;
            document.getElementById('approved-today').textContent = approvedToday;
            document.getElementById('rejected-today').textContent = rejectedToday;
        }

        // Mostrar fila de aprovação
        function showApprovalQueue() {
            showNotification('Info', 'Sistema de aprovação em desenvolvimento', 'info');
        }

        // Mostrar histórico de aprovação
        function showApprovalHistory() {
            showNotification('Info', 'Histórico de aprovações em desenvolvimento', 'info');
        }

        // Mostrar configurações de aprovação
        function showApprovalSettings() {
            showNotification('Info', 'Configurações de aprovação em desenvolvimento', 'info');
        }

        // ===== SISTEMA DE HISTÓRICO DE ALTERAÇÕES =====
        let changeHistory = JSON.parse(localStorage.getItem('changeHistory') || '[]');

        // Inicializar sistema de histórico
        function initHistorySystem() {
            updateHistoryStats();
        }

        // Atualizar estatísticas do histórico
        function updateHistoryStats() {
            const total = changeHistory.length;
            const today = new Date().toDateString();
            const todayChanges = changeHistory.filter(item => 
                new Date(item.timestamp).toDateString() === today
            ).length;
            const activeUsers = [...new Set(changeHistory.map(item => item.user))].length;

            document.getElementById('total-changes').textContent = total;
            document.getElementById('changes-today').textContent = todayChanges;
            document.getElementById('active-users').textContent = activeUsers;
        }

        // Registrar alteração
        function logChange(entity, entityId, action, changes, user) {
            const change = {
                id: Date.now(),
                entity: entity, // 'tarefa', 'cliente', 'tecnico', etc.
                entityId: entityId,
                action: action, // 'created', 'updated', 'deleted'
                changes: changes, // array de mudanças específicas
                user: user || currentUser?.nome || 'Sistema',
                timestamp: new Date()
            };

            changeHistory.unshift(change);
            
            // Manter apenas os últimos 1000 registros
            if (changeHistory.length > 1000) {
                changeHistory = changeHistory.slice(0, 1000);
            }
            
            localStorage.setItem('changeHistory', JSON.stringify(changeHistory));
            updateHistoryStats();
        }

        // Mostrar linha do tempo do histórico
        function showHistoryTimeline() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3 class="modal-title">Histórico de Alterações</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="history-timeline">
                        ${changeHistory.length === 0 ? `
                            <div class="approval-permission">
                                <i class="fas fa-history"></i>
                                <h3>Nenhuma alteração registrada</h3>
                                <p>O histórico de alterações aparecerá aqui</p>
                            </div>
                        ` : changeHistory.map(item => `
                            <div class="history-item">
                                <div class="history-item-icon" style="background: ${getActionColor(item.action)}; color: white;">
                                    <i class="fas fa-${getActionIcon(item.action)}"></i>
                                </div>
                                <div class="history-item-content">
                                    <div class="history-item-title">
                                        ${getActionText(item.action)} ${item.entity}
                                    </div>
                                    <div class="history-item-description">
                                        ${item.changes.map(change => `
                                            <div class="history-change">
                                                <div class="history-change-icon ${change.type}">
                                                    <i class="fas fa-${getChangeIcon(change.type)}"></i>
                                                </div>
                                                <span>${change.field}: ${change.oldValue} → ${change.newValue}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="history-item-meta">
                                        Por: ${item.user} • ${new Date(item.timestamp).toLocaleString('pt-BR')}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Mostrar filtros do histórico
        function showHistoryFilters() {
            showNotification('Info', 'Filtros de histórico em desenvolvimento', 'info');
        }

        // Exportar histórico
        function exportHistory() {
            const data = {
                changeHistory: changeHistory,
                exportDate: new Date().toISOString(),
                totalChanges: changeHistory.length
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `historico-alteracoes-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Sucesso', 'Histórico exportado com sucesso!', 'success');
        }

        // Funções auxiliares para histórico
        function getActionColor(action) {
            const colors = {
                'created': 'var(--success)',
                'updated': 'var(--warning)',
                'deleted': 'var(--danger)'
            };
            return colors[action] || 'var(--gray-500)';
        }

        function getActionIcon(action) {
            const icons = {
                'created': 'plus',
                'updated': 'edit',
                'deleted': 'trash'
            };
            return icons[action] || 'info';
        }

        function getActionText(action) {
            const texts = {
                'created': 'Criado',
                'updated': 'Atualizado',
                'deleted': 'Removido'
            };
            return texts[action] || action;
        }

        function getChangeIcon(type) {
            const icons = {
                'added': 'plus',
                'modified': 'edit',
                'removed': 'minus'
            };
            return icons[type] || 'info';
        }

        // Inicializar sistema de histórico
        document.addEventListener('DOMContentLoaded', function() {
            initHistorySystem();
        });
    </script>
</body>
</html>
